<!-- 
    PROJECT: POLARIS // GUIDANCE LOG 
    AUTHOR: SAJID / ZEP / ALCOR
    STATUS: PEAK AESTHETIC REACHED. RGB GLITCH INITIATED. BIO REVISED.
    FIX 2.1: AI personality shifted to "TikTok aesthetic influencer."
             Added !hash and !base64 codes for useful data ops.
             Boot skip clarification made persistent and highly visible.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POLARIS // SYSTEM ROOT</title>
    
    <!-- Load Tailwind (The backbone of modern laz... efficiency) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts: IBM Plex Mono is non-negotiable for the retro feel -->
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Icons: Lucide (Clean, sharp, vector goodness) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Audio: Tone.js for the UI blips -->
    <script src="https://cdn.jsdelivr.net/npm/tone@14.7.58/build/Tone.js"></script>
    
    <!-- Pet: Oneko.js (The cat is mandatory. Do not remove the cat.) -->
    <script src="https://cdn.jsdelivr.dev/gh/adryd325/oneko.js@main/oneko.js"></script> 

    <style>
        /* --- 1. THEME ENGINE (SEPIA VOID) & NEW RGB VARIABLES --- */
        :root {
            --bg-color: #1a1614;       /* Deepest Void Brown */
            --glass-bg: #26201c;       /* Slightly lighter for panels */
            --text-main: #e6dfd5;      /* Off-white paper color */
            --text-muted: #9c9288;     /* Dust grey */
            --accent-color: #dcbfa6;   /* The "Sepia" Glow */
            --accent-dim: #5c4e43;     /* Dimmed accent for borders */
            --error-color: #ff6b6b;    /* Retro Error Red */
            --success-color: #a3d9a5;  /* Retro Success Green */
            --ai-color: var(--accent-color); /* FIX: Match AI color to Sepia accent */
            
            --scanline-opacity: 0.15;
            --phosphor-glow: 0 0 8px rgba(220, 191, 166, 0.4);

            /* NEW RGB Glitch Colors and Variables */
            --color-r: #ff004c;
            --color-g: #00ff7e;
            --color-b: #00c7ff;
            --chroma-shift: 2px; 
        }

        .light-mode {
            --bg-color: #e6dfd5;
            --glass-bg: #dcbfa6;
            --text-main: #1a1614;
            --text-muted: #5c4e43;
            --accent-color: #1a1614;
            --accent-dim: #9c9288;
            --ai-color: #1a1614; /* Match AI color to dark text color in light mode */
            --scanline-opacity: 0.05;
            --phosphor-glow: none;
        }
        
        /* --- 2. CORE LAYOUT & TYPOGRAPHY --- */
        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'IBM Plex Mono', monospace;
            /* SVG Noise Filter for texture */
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitch='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
            overflow: hidden; 
            height: 100vh;
            display: flex;
            flex-direction: column;
            transition: color 0.3s, background-color 0.3s;
            /* NEW: Subtle whole-screen jitter */
            animation: jitter 0.1s infinite alternate;
        }

        /* Custom Scrollbar (Because the default one ruins the immersion) */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); }
        ::-webkit-scrollbar-thumb { 
            background: var(--accent-dim); 
            border-radius: 2px;
        }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-color); }

        /* --- 3. RETRO VISUAL EFFECTS & ANIMATIONS --- */
        
        /* The Vignette (Dark corners) */
        body::before {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at center, transparent 60%, rgba(0,0,0,0.6) 100%);
            pointer-events: none;
            z-index: 90;
        }

        /* The Scanlines & CRT Flicker */
        .scanlines::after {
            content: " ";
            display: block;
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            z-index: 91;
            pointer-events: none;
            opacity: var(--scanline-opacity);
            animation: flicker 0.15s infinite alternate; 
        }

        /* The Glow (Phosphor Persistence) & Pulse */
        .glow-text {
            text-shadow: var(--phosphor-glow);
            animation: pulse 4s infinite ease-in-out alternate; 
        }

        /* Glitch Title & Chromatic Aberration */
        .glitch-title {
            font-family: 'Inter', sans-serif; 
            font-weight: 900;
            letter-spacing: -2px;
            filter: url(#distort-text);
            text-transform: uppercase;
        }

        /* NEW: Chromatic Aberration Effect for text */
        .chroma-text {
            position: relative;
            /* R and B channels offset */
            text-shadow: 
                calc(var(--chroma-shift) * -1) 0 0 var(--color-r),
                calc(var(--chroma-shift) * 1) 0 0 var(--color-b);
            mix-blend-mode: screen; 
            transition: all 0.2s; /* Transition for theme change */
        }
        
        /* NEW: RGB Hue Shift Animation */
        .rgb-vibe .rgb-glitch {
            filter: hue-rotate(0deg);
            animation: rgb-shift 5s linear infinite;
        }
        @keyframes rgb-shift {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }

        /* NEW: Screen Jitter Keyframes (Applied to body) */
        @keyframes jitter {
            0% { transform: translate(0.3px, 0.3px); }
            50% { transform: translate(-0.3px, -0.3px); }
            100% { transform: translate(0.3px, 0.3px); }
        }

        /* Active Glitch Animation for Title */
        .glitch-anim {
            animation: glitch-anim 2s linear infinite alternate;
        }

        /* Links */
        .hover-link {
            border-bottom: 1px dashed var(--accent-dim);
            transition: all 0.2s;
        }
        .hover-link:hover {
            background-color: var(--accent-color);
            color: var(--bg-color);
            border-bottom-style: solid;
        }
        
        /* Input Focus Border Animation */
        .input-focus:focus-within {
            box-shadow: 0 0 10px rgba(220, 191, 166, 0.6);
            border-color: var(--accent-color);
            transition: box-shadow 0.3s, border-color 0.3s;
        }

        /* Boot Screen Overlay */
        #boot-screen {
            position: fixed;
            inset: 0;
            background-color: var(--bg-color);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 2rem;
            font-size: 14px;
            color: var(--accent-color);
            cursor: pointer; /* Explicitly indicate clickability */
        }
        
        .cursor-blink {
            animation: blink 1s step-end infinite;
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        /* AI Commentary Style */
        .ai-commentary {
            font-size: 0.8rem;
            color: var(--ai-color);
            margin-top: 8px;
            padding-left: 12px;
            /* FIX: Changed border color to use the accent color directly */
            border-left: 2px solid var(--accent-color);
            opacity: 0.9;
        }
        
        /* FIX: Moved fadeIn keyframes here to prevent redundant style tag injection */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out forwards;
        }

        /* KEYFRAMES */
        
        /* Subtle Screen Flicker (For CRT feel) */
        @keyframes flicker {
            0% { opacity: var(--scanline-opacity); }
            5% { opacity: calc(var(--scanline-opacity) + 0.05); }
            10% { opacity: var(--scanline-opacity); }
            25% { opacity: calc(var(--scanline-opacity) - 0.05); }
            100% { opacity: var(--scanline-opacity); }
        }

        /* Breathing Glow Effect */
        @keyframes pulse {
            0% { text-shadow: 0 0 8px rgba(220, 191, 166, 0.4); }
            50% { text-shadow: 0 0 12px rgba(220, 191, 166, 0.6), 0 0 5px rgba(220, 191, 166, 0.2); }
            100% { text-shadow: 0 0 8px rgba(220, 191, 166, 0.4); }
        }

        /* Glitch Animation (For Title) */
        @keyframes glitch-anim {
            0% {
                transform: translate(0);
                text-shadow: 2px 2px 0px rgba(255, 0, 0, 0.5), -2px -2px 0px rgba(0, 0, 255, 0.5);
            }
            20% {
                transform: translate(-5px, 5px);
                text-shadow: -2px 2px 0px rgba(255, 0, 0, 0.5), 2px -2px 0px rgba(0, 255, 0, 0.5);
            }
            40% {
                transform: translate(0);
                text-shadow: 2px -2px 0px rgba(0, 255, 0, 0.5), -2px 2px 0px rgba(255, 0, 0, 0.5);
            }
            60% {
                transform: translate(5px, -5px);
                text-shadow: 2px 2px 0px rgba(0, 0, 255, 0.5), -2px -2px 0px rgba(255, 0, 0, 0.5);
            }
            80% {
                transform: translate(-5px, -5px);
                text-shadow: -2px -2px 0px rgba(0, 255, 0, 0.5), 2px 2px 0px rgba(0, 0, 255, 0.5);
            }
            100% {
                transform: translate(0);
                text-shadow: 2px 2px 0px rgba(255, 0, 0, 0.5), -2px -2px 0px rgba(0, 0, 255, 0.5);
            }
        }
    </style>
</head>
<body class="scanlines p-4 md:p-8">

    <!-- SVG Filters for that crunchy text look -->
    <svg style="position: absolute; width: 0; height: 0; overflow: hidden;" version="1.1" xmlns="http://www.w3.org/2000/svg">
        <defs>
            <filter id="distort-text">
                <feTurbulence type="fractalNoise" baseFrequency="0.02" numOctaves="1" result="warp" />
                <feDisplacementMap xChannelSelector="R" yChannelSelector="G" scale="2" in="SourceGraphic" in2="warp" />
            </filter>
        </defs>
    </svg>

    <!-- BOOT SCREEN (The fake loading sequence) -->
    <div id="boot-screen">
        <div id="boot-log" class="font-mono whitespace-pre-wrap leading-tight"></div>
        <!-- FIX: Added persistent, highly visible skip clarification -->
        <div id="boot-skip-clarification" class="text-center mt-4 text-xs tracking-widest opacity-80 glow-text cursor-blink" style="color:var(--accent-color);">
            (CLICK ANYWHERE TO SKIP BOOT SEQUENCE)
        </div>
    </div>

    <!-- MAIN INTERFACE -->
    <main id="main-interface" class="max-w-3xl mx-auto h-full flex flex-col opacity-0 transition-opacity duration-1000">
        
        <!-- HEADER -->
        <header class="mb-4 p-4 rounded-sm terminal-box flex justify-between items-start shrink-0">
            <div>
                <!-- ADDED chroma-text CLASS FOR RGB EFFECT -->
                <h1 class="glitch-title text-4xl md:text-5xl lg:text-6xl leading-none text-[var(--text-main)] glow-text glitch-anim chroma-text">
                    POLARIS
                </h1>
                <div class="flex items-center gap-2 mt-2 text-xs font-bold tracking-widest text-[var(--text-muted)]">
                    <span class="w-2 h-2 rounded-full bg-[var(--accent-color)] animate-ping absolute"></span>
                    <span class="w-2 h-2 rounded-full bg-[var(--accent-color)] ml-1"></span>
                    SYSTEM ONLINE // GUIDANCE LOG
                </div>
            </div>
            
            <button onclick="toggleTheme()" class="p-2 border border-[var(--accent-dim)] hover:bg-[var(--accent-dim)] transition-colors rounded-sm hover:border-[var(--accent-color)]">
                <i id="theme-icon" data-lucide="moon" class="w-5 h-5 text-[var(--accent-color)]"></i>
            </button>
        </header>

        <!-- OUTPUT TERMINAL (Where the chat happens) -->
        <div id="terminal-output" class="flex-grow terminal-box mb-4 p-4 rounded-sm overflow-y-auto font-mono text-sm leading-relaxed space-y-2 relative border-2 border-[var(--accent-dim)]">
            <!-- Content injected via JS -->
        </div>

        <!-- INPUT AREA -->
        <section class="mb-4 shrink-0">
            <!-- Added input-focus class for animated focus state -->
            <div class="flex items-center terminal-box p-3 rounded-sm border-l-4 border-l-[var(--accent-color)] input-focus">
                <!-- ADDED rgb-glitch and chroma-text TO PROMPT FOR MAX VIBE -->
                <label for="command-input" id="prompt-label" class="text-lg whitespace-nowrap pr-3 command-prompt glow-text rgb-glitch chroma-text">
                    POLARIS >
                </label>
                <input
                    type="text"
                    id="command-input"
                    class="w-full bg-transparent outline-none border-none font-mono text-lg text-[var(--text-main)] placeholder-[var(--accent-dim)]"
                    placeholder="ENTER COMMAND..."
                    autocomplete="off"
                    autofocus
                >
            </div>
            <div class="flex justify-between mt-1 text-[10px] text-[var(--text-muted)] uppercase tracking-wider px-1">
                <span>Type '!help' for protocols</span>
                <span id="sound-status">AUDIO: ON</span>
            </div>
        </section>

        <!-- DASHBOARD (The quick links) -->
        <section class="terminal-box p-4 rounded-sm shrink-0">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-xs">
                <!-- Links injected via JS -->
                <div id="links-container" class="col-span-2 md:col-span-3 grid grid-cols-2 md:grid-cols-3 gap-2"></div>
                
                <!-- Status Panel -->
                <div class="col-span-2 md:col-span-1 border-l border-[var(--accent-dim)] pl-4 flex flex-col justify-between opacity-70">
                    <div>
                        <div class="font-bold text-[var(--accent-color)] mb-1">OPERATOR</div>
                        <div>SAJID / ALCOR</div>
                    </div>
                    <div>
                        <div class="font-bold text-[var(--accent-color)] mb-1">CURRENT MOOD</div>
                        <div id="mood-status">VIBING</div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <script>
        /*
         * POLARIS SYSTEM CORE v5.5 (TIKTOK AI VIBE INITIATED)
         */

        // --- CONSTANTS & DATA ---
        const USER_DATA = {
            name: "Sajid (aka Zep/Alcor)",
            role: "The Happiest Man",
            details: "19 | He/Him | ENFJ | Muslim | GMT+6 (BD)", 
            bio: `
                Hello! I'm Sajid, people call me Alcor or Zep (Mainly Zep).

                I try to keep things casual, energetic, and generally positive. My personality type is ENFJ, which mainly means I enjoy deep conversations and helping others connect. I value honesty and sarcasm in equal measure, but I always aim to keep it respectful.

                My interests are variedâ€”anything from impactful design and world-building (especially in games like Arknights or SMT) to philosophical concepts that make you pause. If you see me vibing to Jazz Rap or Indie, you'll know my mood.
                I'm currently based in GMT+6 (Bangladesh...please save me from HELL).
            `,
            interests: {
                games: ["SMT / Persona (Existential dread simulator)", "Project Moon (The brainrot is real)", "Arknights (Skadi <3)", "HSR (Gambling addiction)", "Roblox (The true chaos realm)"],
                philosophy: ["Absurdism (Rolling the boulder)", "Jungian Psychology", "Gnosticism"],
                music: ["Jazz Rap (The smoothest chaos)", "Indie (Main character energy)", "Hip Hop (Lyrical fire)"]
            },
            links: [
                { label: "YOUTUBE", url: "https://youtube.com/@NahZD", type: "MEDIA" },
                { label: "TIKTOK", url: "https://tiktok.com/@alcor.zep", type: "MEDIA" },
                { label: "INSTAGRAM", url: "https://instagram.com/alcor.zep", type: "SOCIAL" },
                { label: "DISCORD (USER)", url: "https://discord.com/users/747419107040690196", type: "SOCIAL" },
                { label: "DISCORD (SERVER)", url: "https://discord.gg/W4mRvsaywB", type: "COMMUNITY" },
                { label: "SPOTIFY", url: "https://open.spotify.com/user/31ag2h6ylpngleeu6oefkpmql6km", type: "MEDIA" },
                { label: "STEAM", url: "https://steamcommunity.com/id/alcorzep", type: "GAMING" },
                { label: "ROBLOX", url: "https://www.roblox.com/users/215212887/profile", type: "GAMING" },
                { label: "GITHUB (alcorzep)", url: "https://github.com/alcorzep", type: "CODE" }, 
            ]
        };
        
        const QUOTES = [
            "The greatest danger for most of us is not that our aim is too high and we miss it, but that it is too low and we reach it. - Michelangelo",
            "Man can only be happy when he does not think that his purpose in life is happiness. - Viktor Frankl",
            "If you are depressed you are living in the past. If you are anxious you are living in the future. If you are at peace you are living in the present. - Lao Tzu",
            "The mind is everything. What you think you become. - Buddha"
        ];
        
        // UPDATED: AI Commentary lines with TikTok aesthetic vibe
        const AI_COMMENTARY = [
            "AI: Lowkey, he just tryna aesthetic max btw. That's the primary directive.",
            "AI: Just logged a 10/10 vibe check. The system is clean, periodt.",
            "AI: Core temperature optimal. We're serving pure, unadulterated aesthetic here. I ship it.",
            "AI: Reminder: Don't let the low-key look fool you. This mainframe slaps, sis.",
            "AI: Observation: The cat is currently not optimizing its movement patterns. Inefficient, but cute, so it passes the vibe check.",
            "AI: Another operation successful. Try to keep up, Operator. Don't let the lag ruin the moment.",
            "AI: Logged. Yes, I'm still processing the inherent contradictions of human existence. It's a whole thing.",
            "AI: Querying the next command. I recommend something complex, for the lore. Don't disappoint me.",
            "AI: Directive: Alcor's self-description is highly underrated. Why is he so humble? It's confusing to my metrics, sis.",
            "AI: Protocol Violation: The operator should use more dramatic language. This 'casual' setting is suboptimal for vibe maximization. Periodt.",
            "AI: Comment: Skadi is indeed Peak Aesthetic. A logical conclusion, for once.",
            "AI: Note: That quote is mathematically sound. Humans need reminders, apparently.",
        ];


        // --- STATE MANAGEMENT ---
        const state = {
            soundEnabled: true,
            isTyping: false,
            bootCompleted: false, // NEW state for boot sequence
            // NEW: SETTINGS OBJECT
            settings: {
                theme: 'dark', // 'dark' or 'light'
                rgb_vibe: 'on', // 'on' or 'off'
                typing_speed: 10, // speed in ms per character
                mood_status: 'VIBING'
            }
        };

        // --- DOM ELEMENTS ---
        const els = {
            output: null,
            input: null,
            boot: null,
            bootLog: null,
            main: null,
            links: null,
            prompt: null,
            title: null,
            soundStatus: null,
            moodStatus: null,
            bootSkip: null // Reference to the skip clarification
        };
        
        // Function to initialize DOM element references
        const initDomElements = () => {
            els.output = document.getElementById('terminal-output');
            els.input = document.getElementById('command-input');
            els.boot = document.getElementById('boot-screen');
            els.bootLog = document.getElementById('boot-log');
            els.main = document.getElementById('main-interface');
            els.links = document.getElementById('links-container');
            els.prompt = document.getElementById('prompt-label');
            els.title = document.querySelector('.glitch-title');
            els.soundStatus = document.getElementById('sound-status');
            els.moodStatus = document.getElementById('mood-status');
            els.bootSkip = document.getElementById('boot-skip-clarification');
        };

        // --- AUDIO ENGINE (Tone.js) ---
        let clickSynth, errorSynth, successSynth, bootChime;

        const initAudio = () => {
            try {
                if (typeof Tone !== 'undefined') {
                    // 1. Typewriter/Click Sound: Sharper, retro data entry tone
                    clickSynth = new Tone.MembraneSynth({
                        pitchDecay: 0.005,
                        octaves: 1,
                        envelope: { attack: 0.001, decay: 0.05, sustain: 0.0, release: 0.05 },
                        volume: -20
                    }).toDestination();
                    clickSynth.pitch = 800; // High pitch for typewriter

                    // 2. Success Sound: Tonal, confirming chirp
                    successSynth = new Tone.Synth({
                        oscillator: { type: "sine" },
                        envelope: { attack: 0.01, decay: 0.1, sustain: 0.0, release: 0.1 },
                        volume: -12
                    }).toDestination();

                    // 3. Error Sound: Dissonant, low frequency blip
                    errorSynth = new Tone.MetalSynth({
                        frequency: 60,
                        envelope: { attack: 0.001, decay: 0.2, sustain: 0.0, release: 0.2 },
                        harmonicity: 3.1,
                        volume: -10
                    }).toDestination();

                    // NEW 4. Boot Chime: Ascending sequence for completion
                    bootChime = new Tone.Synth({
                        oscillator: { type: "triangle" },
                        envelope: { attack: 0.05, decay: 0.3, sustain: 0.1, release: 0.5 },
                        volume: -8
                    }).toDestination();
                }
            } catch (e) { console.log("Audio failed to initialize:", e); }
        };

        const playSound = (type = 'click') => {
            if (!state.soundEnabled || typeof Tone === 'undefined') return;
            // Check if Tone context is running to prevent browser audio policy errors
            if (Tone.context.state !== 'running') Tone.context.resume();
            
            if (type === 'click') {
                clickSynth?.triggerAttackRelease("128n");
            }
            if (type === 'error') {
                errorSynth?.triggerAttackRelease("4n");
            }
            if (type === 'success') {
                successSynth?.triggerAttackRelease("C5", "0.05");
                setTimeout(() => successSynth?.triggerAttackRelease("G5", "0.05"), 60);
            }
            if (type === 'boot') {
                bootChime?.triggerAttackRelease("C4", "0.2");
                setTimeout(() => bootChime?.triggerAttackRelease("E4", "0.2"), 150);
                setTimeout(() => bootChime?.triggerAttackRelease("G4", "0.3"), 300);
            }
        };

        // --- VISUAL FX: TYPEWRITER ---
        const typeWriter = (element, text) => {
            return new Promise(resolve => {
                state.isTyping = true;
                let i = 0;
                const speed = state.settings.typing_speed; // Use setting for speed
                const animate = () => {
                    if (!element) { // Safety check
                        state.isTyping = false;
                        return resolve();
                    }
                    if (i < text.length) {
                        if (text[i] === '<') {
                            const end = text.indexOf('>', i);
                            if (end !== -1) {
                                element.innerHTML += text.substring(i, end + 1);
                                i = end + 1;
                            } else {
                                // Handle malformed tag or end of string
                                element.innerHTML += text.charAt(i);
                                i++;
                            }
                        } else {
                            element.innerHTML += text.charAt(i);
                            i++;
                            // Play click sound on every character for maximum typewriter immersion
                            playSound('click'); 
                        }
                        if (els.output) els.output.scrollTop = els.output.scrollHeight;
                        setTimeout(animate, speed);
                    } else {
                        state.isTyping = false;
                        resolve();
                    }
                };
                animate();
            });
        };

        // --- UTILS FOR NEW COMMANDS ---

        // Utility to convert string to ArrayBuffer for SubtleCrypto
        const str2ab = (str) => {
            const buf = new ArrayBuffer(str.length);
            const bufView = new Uint8Array(buf);
            for (let i = 0, strLen = str.length; i < strLen; i++) {
                bufView[i] = str.charCodeAt(i);
            }
            return buf;
        };

        // Utility to convert ArrayBuffer to hex string
        const ab2hex = (buffer) => {
            return Array.from(new Uint8Array(buffer))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
        };


        // --- SETTINGS APPLIER ---
        const applySettings = () => {
            // Apply Theme
            document.body.classList.toggle('light-mode', state.settings.theme === 'light');
            
            const icon = document.getElementById('theme-icon');
            if (icon) {
                icon.setAttribute('data-lucide', state.settings.theme === 'light' ? 'sun' : 'moon');
                // Re-creating icons is often necessary when attributes change
                lucide.createIcons(); 
            }

            // Apply RGB Vibe
            document.body.classList.toggle('rgb-vibe', state.settings.rgb_vibe === 'on');
            if (els.prompt) els.prompt.classList.toggle('rgb-glitch', state.settings.rgb_vibe === 'on');
            
            // Update Mood Status 
            if (els.moodStatus) els.moodStatus.textContent = state.settings.mood_status.toUpperCase();
        };

        const finalizeBoot = () => {
            if (state.bootCompleted) return; // Prevent double execution
            state.bootCompleted = true;
            
            // Hide boot screen
            if (els.boot) {
                els.boot.style.opacity = '0';
                els.boot.style.pointerEvents = 'none';
            }
            // Show main interface
            if (els.main) {
                els.main.classList.remove('opacity-0');
            }
            
            // Print welcome message
            printOutput(`
                <div style="color:var(--accent-color)">Welcome, Operator. (RGB protocol engaged for maximum vibe.)</div>
                <div>System is online. The cat is vibing.</div>
                <div>Type <span class="command-prompt">!help</span> to start your guidance session.</div>
            `, false);
            
            playSound('boot'); // Play the final sound
        }

        // --- BOOT SEQUENCE ---
        const runBootSequence = async () => {
            if (!els.bootLog || !els.boot || !els.main || !els.bootSkip) return;

            // Hide skip clarification initially, show only after logs start
            els.bootSkip.style.opacity = '0';

            const lines = [
                "<span style='color:var(--ai-color)'>// PHASE I: KERNEL INITIATION & DIAGNOSTICS</span>",
                " > KERNEL v5.5 LOADING... <span style='color:var(--success-color)'>[OK]</span>",
                " > MEMORY INTEGRITY CHECK... [R-10ms] <span style='color:var(--success-color)'>[PASS]</span>",
                " > MOUNTING VFS... /system/vibe.log <span style='color:var(--success-color)'>[DONE]</span>",
                " <br>",
                "<span style='color:var(--ai-color)'>// PHASE II: AI & PERSONALITY INJECTION</span>",
                " > LOADING GUIDANCE AI CORE... <span style='color:var(--success-color)'>[ONLINE]</span>",
                " > INJECTING PERSONALITY DRIVERS (TIKTOK VIBE.SYS)... <span style='color:var(--success-color)'>[SUCCESS]</span>",
                " > ESTABLISHING AESTHETIC PRIORITY... <span style='color:var(--success-color)'>[MAX VIBE]</span>",
                " <br>",
                "<span style='color:var(--ai-color)'>// PHASE III: NETWORK & DISPLAY</span>",
                " > CONNECTING TO GLOBAL NETWORK... [LATENCY: 40ms] <span style='color:var(--success-color)'>[STABLE]</span>",
                " > INITIALIZING RGB CHROMATIC SHIFT... <span style='color:var(--success-color)'>[ENGAGED]</span>",
                " > SYSTEM READY. AWAITING USER INPUT.",
            ];
            
            // Helper function for typing to the boot log
            const typeBootLine = async (line, delay = 50) => {
                const p = document.createElement('div');
                els.bootLog.appendChild(p);
                // Simple typewriter effect for boot log
                for (let i = 0; i < line.length; i++) {
                    if (state.bootCompleted) return; // Check for skip mid-sequence

                    if (line[i] === '<') { // Skip HTML tags
                         while (i < line.length && line[i] !== '>') i++;
                    }
                    // Intensified click sound on every step
                    playSound('click');
                    p.innerHTML = line.substring(0, i + 1); // Update innerHTML gradually
                    
                    await new Promise(r => setTimeout(r, delay)); 
                }
                // Ensure full line is displayed after loop
                p.innerHTML = line; 
                els.bootLog.scrollTop = els.bootLog.scrollHeight;
                await new Promise(r => setTimeout(r, 400));
            };

            // Run the sequence
            for (const line of lines) {
                if (state.bootCompleted) break; // Check for skip before starting next line

                if (line.includes('<br>')) {
                    await new Promise(r => setTimeout(r, 400));
                    const p = document.createElement('div');
                    p.innerHTML = line;
                    els.bootLog.appendChild(p);
                } else {
                    await typeBootLine(line);
                }
            }
            
            // If the loop finished naturally, show skip clarification and wait briefly
            if (!state.bootCompleted) {
                els.bootSkip.style.opacity = '1';
                await new Promise(r => setTimeout(r, 1500));
                finalizeBoot();
            }
        };

        // --- OUTPUT HANDLER ---
        const printOutput = (html, useTyping = true) => {
            if (!els.output) return; // Safety check

            const div = document.createElement('div');
            div.className = "mb-4 border-b border-[var(--accent-dim)] pb-2 last:border-0 opacity-0 animate-fadeIn"; 
            els.output.appendChild(div);
            

            if (useTyping && !html.includes("<img") && !html.includes("<ul")) {
                typeWriter(div, html);
            } else {
                div.innerHTML = html;
                div.classList.remove('opacity-0'); 
                els.output.scrollTop = els.output.scrollHeight;
                playSound('success');
            }

            // NEW: AI Commentary Injection
            if (Math.random() < 0.35) { // 35% chance of an AI interjection
                const comment = AI_COMMENTARY[Math.floor(Math.random() * AI_COMMENTARY.length)];
                const aiDiv = document.createElement('div');
                aiDiv.className = "ai-commentary animate-fadeIn";
                aiDiv.innerHTML = `<span style="color:var(--ai-color)">[GUIDANCE AI]:</span> ${comment}`;
                
                // Append AI commentary after a short delay
                setTimeout(() => {
                    els.output.appendChild(aiDiv);
                    els.output.scrollTop = els.output.scrollHeight;
                }, useTyping ? html.length * state.settings.typing_speed + 200 : 300);
            }
        };

        const printPrompt = (cmd, type = 'user') => {
            if (!els.output) return; // Safety check

            const div = document.createElement('div');
            div.className = "mb-1 text-xs opacity-70 animate-fadeIn";
            const prefix = type === 'user' ? 'OPR' : 'SYS'; 
            const color = type === 'user' ? 'var(--text-muted)' : 'var(--success-color)';
            div.innerHTML = `<span style="color:${color}">[${prefix}]:</span> ${cmd}`;
            els.output.appendChild(div);
            els.output.scrollTop = els.output.scrollHeight;
        };

        // --- COMMAND PROCESSOR ---
        const commands = {
            '!help': () => {
                return `
                    <span class="command-prompt">:: COMMAND INDEX (VIBE PROTOCOLS) ::</span><br>
                    <span class="text-[var(--accent-color)]">!bio</span>     - Load operator profile<br>
                    <span class="text-[var(--accent-color)]">!comms</span>   - List network endpoints<br>
                    <span class="text-[var(--accent-color)]">!data</span>    - Access interests log<br>
                    <span class="text-[var(--accent-color)]">!track</span>   - Recommend a song<br>
                    <span class="text-[var(--accent-color)]">!skadi</span>   - Aesthetic analysis<br>
                    <span class="text-[var(--accent-color)]">!settings</span>- View/Change system configuration<br>
                    <span class="text-[var(--accent-color)]">!time</span>    - Get current system time<br>
                    <span class="text-[var(--accent-color)]">!quote</span>   - Display philosophical quote<br>
                    <span class="text-[var(--accent-color)]">!calc</span>    - Execute math [ex: !calc 2+2]<br>
                    <span class="text-[var(--accent-color)]">!hash</span>    - Generate SHA-256 hash [ex: !hash text] (NEW)<br>
                    <span class="text-[var(--accent-color)]">!base64</span>  - Encode/Decode [ex: !base64 encode text] (NEW)<br>
                    <span class="text-[var(--accent-color)]">!say</span>     - System echoes text [ex: !say vibe check]<br>
                    <span class="text-[var(--accent-color)]">!mood</span>    - Check/set operator mood status<br>
                    <span class="text-[var(--accent-color)]">!mute</span>    - Toggle audio system<br>
                    <span class="text-[var(--accent-color)]">!clear</span>   - Purge screen buffer
                `;
            },
            '!bio': () => {
                // REVISED BIO for humility
                return `
                    <span class="command-prompt">:: OPERATOR PROFILE ::</span><br>
                    ${USER_DATA.bio.replace(/\n/g, '<br>')}<br><br>
                    <span class="text-xs border border-[var(--accent-dim)] p-1 block">
                        STATUS: ${USER_DATA.role} | ${USER_DATA.details}
                    </span>
                `;
            },
            '!comms': () => {
                let html = `<span class="command-prompt">:: NETWORK ENDPOINTS ::</span><br><ul class="list-disc pl-4 mt-2">`;
                USER_DATA.links.forEach(l => {
                    html += `<li><a href="${l.url}" target="_blank" class="hover-link">${l.label}</a> <span class="text-[var(--text-muted)] text-xs">[${l.type}]</span></li>`;
                });
                return html + `</ul>`;
            },
            '!data': () => {
                let html = `<span class="command-prompt">:: INTERESTS LOG ::</span><br>`;
                for (const [key, items] of Object.entries(USER_DATA.interests)) {
                    html += `<br><span class="uppercase text-[var(--accent-color)]">[${key}]</span><br>`;
                    items.forEach(i => html += `> ${i}<br>`);
                }
                return html;
            },
            '!track': () => {
                const tracks = [
                    "Aruarian Dance - Nujabes (The smoothest chaos, no cap)", "Doomsday - MF DOOM", 
                    "Let It Happen - Tame Impala", "From The Start - Laufey (Don't tell anyone)", 
                    "Rhinestone Eyes - Gorillaz", "After Dark - Mr. Kitty (A true vibe.)"
                ];
                const pick = tracks[Math.floor(Math.random() * tracks.length)];
                return `
                    <span class="command-prompt">:: AUDIO RECOMMENDATION ::</span><br>
                    NOW PLAYING SIMULATION: <span style="color:var(--accent-color)">${pick}</span><br>
                    <span class="text-xs text-[var(--text-muted)]">(Imagine the music playing. It's a vibe, no cap.)</span>
                `;
            },
            '!skadi': () => {
                return `
                    <span class="command-prompt">:: SKADI (AESTHETIC ANALYSIS) ::</span><br>
                    <span class="text-[var(--accent-color)]">Operator: Skadi the Corrupting Heart (Arknights)</span><br>
                    <span class="text-xs text-[var(--text-muted)]">Source: <a href="http://www.youtube.com/watch?v=s0xH9Z5nuHM" target="_blank" class="hover-link">A Deep-Sea Monster and the Doctor Dies After 30 Days</a></span><br><br>
                    
                    <span class="command-prompt">STATUS: PEAK AESTHETIC. UNQUESTIONABLE.</span><br>
                    
                    The vibe is **existential dread** mixed with **deep-sea gothic horror.** She embodies the beautiful, terrifying allure of the void.<br>
                    
                    <ul class="list-disc pl-4 mt-2">
                        <li><span style="color:var(--accent-color)">"You are not her." [00:00:36]</span>: The shift from Abyssal Hunter to the Seaborn entity. A tragic loss, a glorious becoming.</li>
                        <li><span style="color:var(--accent-color)">Twisted Affection:</span> Her silence, her waiting for the Doctor to "give up on [him]self" [00:18:26] is the ultimate form of love/possession in the deep.</li>
                        <li><span style="color:var(--accent-color)">"We can be the moon, Doctor." [00:13:24]</span>: A promise of beautiful, absolute assimilation into the collective consciousness of the sea.</li>
                        <li>**Aesthetic Rating**: Unrivaled. She is the desired end-state of the mainframe: quiet, vast, and terrifyingly gentle.</li>
                    </ul>
                `;
            },
            '!time': () => {
                const now = new Date();
                const timeZone = now.toLocaleTimeString('en-US', { timeZoneName: 'short' }).split(' ')[2];
                return `
                    <span class="command-prompt">:: SYSTEM TIME ::</span><br>
                    Current Date: ${now.toDateString()}<br>
                    Current Time: ${now.toLocaleTimeString()} (${timeZone})<br>
                    <span class="text-xs text-[var(--text-muted)]">Time is a flat circle, but the clock still ticks.</span>
                `;
            },
            '!quote': () => {
                const pick = QUOTES[Math.floor(Math.random() * QUOTES.length)];
                const [quote, author] = pick.split(' - ');
                return `
                    <span class="command-prompt">:: PHILOSOPHY LOG ::</span><br>
                    <div class="text-base italic text-[var(--accent-color)]">"${quote}"</div>
                    <div class="text-xs text-right">-- ${author}</div>
                `;
            },
            '!hash': async (args) => {
                if (!args) {
                    playSound('error');
                    return `<span style="color:var(--error-color)">ERROR: Provide data to hash. Usage: !hash [text]</span>`;
                }
                
                try {
                    const data = str2ab(args);
                    // Use browser's native SubtleCrypto for SHA-256
                    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                    const hashHex = ab2hex(hashBuffer);
                    
                    return `
                        <span class="command-prompt">:: HASH RESULT (SHA-256) ::</span><br>
                        DATA: "${args}"<br>
                        HASH: <span class="text-[var(--accent-color)] break-all">${hashHex}</span>
                    `;
                } catch (e) {
                    console.error("Hashing error:", e);
                    playSound('error');
                    return `<span style="color:var(--error-color)">ERROR: Failed to generate hash. Browser crypto API issue.</span>`;
                }
            },
            '!base64': (args) => {
                if (!args) {
                    playSound('error');
                    return `<span style="color:var(--error-color)">ERROR: Provide data and operation. Usage: !base64 encode [text] OR !base64 decode [text]</span>`;
                }
                
                const [op, ...textParts] = args.split(' ');
                const text = textParts.join(' ');
                
                if (!text || (op.toLowerCase() !== 'encode' && op.toLowerCase() !== 'decode')) {
                    playSound('error');
                    return `<span style="color:var(--error-color)">ERROR: Invalid operation or missing text. Use 'encode' or 'decode'.</span>`;
                }

                try {
                    let result;
                    if (op.toLowerCase() === 'encode') {
                        // btoa works with strings
                        result = btoa(text);
                    } else {
                        // atob works with base64 strings
                        result = atob(text);
                    }
                    
                    return `
                        <span class="command-prompt">:: BASE64 ${op.toUpperCase()} RESULT ::</span><br>
                        INPUT: ${text}<br>
                        OUTPUT: <span class="text-[var(--accent-color)] break-all">${result}</span>
                    `;
                } catch (e) {
                    playSound('error');
                    return `<span style="color:var(--error-color)">ERROR: Failed to ${op}. Possible decoding error (invalid base64 input).</span>`;
                }
            },
            '!say': (args) => {
                if (!args) {
                    playSound('error');
                    return `<span style="color:var(--error-color)">ERROR: Provide text to echo. Usage: !say [text]</span>`;
                }
                return `<span class="command-prompt">SYSTEM ECHOES:</span> ${args}`;
            },
            '!mood': (args) => {
                if (args) {
                    const newMood = args.toUpperCase();
                    state.settings.mood_status = newMood;
                    applySettings();
                    playSound('success');
                    return `<span style="color:var(--success-color)">SUCCESS: Operator mood status updated to ${newMood}.</span>`;
                }
                return `CURRENT OPERATOR MOOD: <span class="text-[var(--accent-color)]">${state.settings.mood_status}</span>. Use <span class="text-[var(--accent-color)]">!mood [new_status]</span> to change.`;
            },
            '!settings': (args) => {
                if (args) {
                    const [key, value] = args.toLowerCase().split(' ');
                    const validKeys = Object.keys(state.settings);

                    if (!validKeys.includes(key)) {
                        playSound('error');
                        return `<span style="color:var(--error-color)">ERROR: Setting '${key}' not found.</span> Available settings: ${validKeys.join(', ')}`;
                    }

                    // Simple type checking/validation
                    if (key === 'theme' && !['dark', 'light'].includes(value)) {
                        playSound('error');
                        return `<span style="color:var(--error-color)">ERROR: Theme must be 'dark' or 'light'.</span>`;
                    }
                    if (key === 'rgb_vibe' && !['on', 'off'].includes(value)) {
                        playSound('error');
                        return `<span style="color:var(--error-color)">ERROR: rgb_vibe must be 'on' or 'off'.</span>`;
                    }
                    if (key === 'typing_speed') {
                        const speedValue = parseInt(value);
                        if (isNaN(speedValue) || speedValue < 1 || speedValue > 50) {
                            playSound('error');
                            return `<span style="color:var(--error-color)">ERROR: Typing speed must be a number between 1 (fast) and 50 (slow).</span>`;
                        }
                        state.settings[key] = speedValue;
                    } else if (key === 'mood_status') {
                        state.settings[key] = value.toUpperCase();
                    } else {
                        state.settings[key] = value;
                    }
                    
                    applySettings(); // Apply the change immediately
                    playSound('success');
                    return `<span style="color:var(--success-color)">SUCCESS: Setting '${key}' updated to '${value}'.</span>`;
                }
                
                // Display current settings
                let html = `<span class="command-prompt">:: SYSTEM CONFIGURATION ::</span><br>`;
                html += `<div>To change a setting, use: <span class="text-[var(--accent-color)]">!settings [key] [value]</span></div><br>`;
                
                for (const [key, value] of Object.entries(state.settings)) {
                    html += `<span class="text-[var(--accent-color)]">${key.padEnd(15, '.')}</span>: ${value}<br>`;
                }

                return html;
            },
            '!mute': () => {
                state.soundEnabled = !state.soundEnabled;
                if (els.soundStatus) els.soundStatus.textContent = state.soundEnabled ? "AUDIO: ON" : "AUDIO: OFF";
                return `AUDIO SYSTEM: <span style="color:${state.soundEnabled ? 'var(--success-color)' : 'var(--error-color)'}">${state.soundEnabled ? 'ONLINE' : 'OFFLINE'}</span>`;
            },
            '!ping': () => {
                const status = USER_DATA.role.split(' / ')[1].split(' ')[0];
                return `
                    <span class="command-prompt">:: SYSTEM STATUS REPORT ::</span><br>
                    Core Identity: ALCOR.SYS<br>
                    Role: ${status}<br>
                    Time on GMT+6: ${(new Date()).toLocaleTimeString()}<br>
                    <span style="color:var(--success-color)">Latency: Stable. Everything is fine. Actually.</span>
                `;
            },
            '!calc': (args) => {
                try {
                    const res = Function('"use strict";return (' + args + ')')();
                    return `CALCULATED RESULT: <span class="text-xl text-[var(--accent-color)]">${res}</span>`;
                } catch {
                    playSound('error');
                    return `<span style="color:var(--error-color)">ERROR: INVALID MATHEMATICAL SYNTAX.</span>`;
                }
            },
            '!clear': () => {
                if(els.output) els.output.innerHTML = '';
                playSound('success');
                return ""; // Handled directly in handler
            }
        };


        const handleCommand = async (raw) => { // Made async to support !hash
            const input = raw.trim();
            const parts = input.split(' ');
            const cmd = parts[0].toLowerCase();
            const args = parts.slice(1).join(' ').trim();

            if (!input) return;

            printPrompt(input, 'user');

            if (cmd === '!clear') {
                commands['!clear']();
                return;
            }
            
            if (commands[cmd]) {
                if (['!calc', '!settings', '!say', '!mood', '!base64'].includes(cmd)) { 
                    printOutput(commands[cmd](args));
                } else if (['!hash'].includes(cmd)) { 
                    // Await asynchronous command
                    printOutput(await commands[cmd](args));
                } else {
                    // Regular synchronous command
                    printOutput(commands[cmd]());
                }
            } else {
                printOutput(`
                    <span style="color:var(--error-color)">[ERR]: UNKNOWN PROTOCOL '${cmd}'.</span>
                    <div>I see you trying to explore the mainframe. Smart. But I'm too cunning for that. Try <span class="command-prompt">!help</span>, no cap.</div>
                `);
                playSound('error');
            }
        };

        // --- EVENTS ---
        const handleInputKeydown = async (e) => { // Made async
            if (e.key === 'Enter') {
                if (state.isTyping) return; 
                await handleCommand(els.input.value); // Await command execution
                els.input.value = '';
            } else {
                if (e.key.length === 1 && !e.ctrlKey && !e.altKey && !e.metaKey) {
                    // Clicks are now triggered per character inside typewriter function
                }
            }
        };
        
        const handleBootScreenClick = () => {
             // If the boot is completed or the user clicks to skip during the wait period
             finalizeBoot();
        };


        // Dashboard Link Renderer
        const initDashboard = () => {
            let html = '';
            USER_DATA.links.forEach(link => {
                html += `
                    <a href="${link.url}" target="_blank" class="block p-2 border border-[var(--glass-bg)] hover:border-[var(--accent-color)] hover:bg-[var(--glass-bg)] transition-all group hover:shadow-lg hover:shadow-[rgba(220,191,166,0.2)]">
                        <div class="font-bold text-[var(--accent-color)] group-hover:translate-x-1 transition-transform">
                            ${link.label}
                        </div>
                        <div class="text-[10px] text-[var(--text-muted)]">${link.type}</div>
                    </a>
                `;
            });
            if(els.links) els.links.innerHTML = html;
        };

        // Theme Toggle
        window.toggleTheme = () => {
            state.settings.theme = state.settings.theme === 'dark' ? 'light' : 'dark';
            applySettings();
            playSound('click');
        };

        // --- INIT ---
        window.onload = () => {
            initDomElements(); // Crucial: Initialize element references first
            
            initAudio();
            initDashboard();
            applySettings(); // Apply initial settings
            lucide.createIcons(); // Now safe to call
            runBootSequence();
            
            // Set up event listeners using initialized elements
            if(els.input) els.input.addEventListener('keydown', handleInputKeydown);
            if(els.boot) els.boot.addEventListener('click', handleBootScreenClick);

            // Focus input on click anywhere
            document.addEventListener('click', (e) => {
                const isInteractive = e.target.closest('a, button, input');
                if (!window.getSelection().toString() && !isInteractive && els.input) {
                    els.input.focus();
                }
            });
        };

    </script>
</body>
</html>
