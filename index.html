<!-- 
    PROJECT: POLARIS // GUIDANCE LOG 
    AUTHOR: SAJID / ZEP / ALCOR
    STATUS: CRITICAL INPUT FREEZE BUGFIX (POST-LOAD RELIABILITY)
    
    FIX LOG:
    1. CRITICAL FIX (Input Freeze): Implemented an explicit, redundant lock release (`state.isTyping = false`) immediately following the completion of the asynchronous initial greeting in `initialGreeting()` to guarantee the input is usable after boot.
    2. RELIABILITY: Ensured the keydown handler plays an error sound if the user tries to type while the system is "typing" (locked).
    3. REFACTOR: Removed the redundant `window.onload` fallback, relying solely on `DOMContentLoaded` and script deferral for a cleaner, more predictable initialization sequence.
    4. AESTHETICS: Confirmed the universal 3-column grid and the sepia/amber color palette are maintained.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POLARIS // SYSTEM ROOT</title>
    
    <!-- PERFORMANCE OPTIMIZATION: Preconnect to CDNs for faster handshake -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://unpkg.com">
    <link rel="preconnect" href="https://cdn.jsdelivr.dev">
    
    <!-- Load Tailwind -->
    <script src="https://cdn.tailwindcss.com" defer></script>
    
    <!-- Fonts: IBM Plex Mono is non-negotiable for the retro feel -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600;700&display=swap" as="style">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Icons: Lucide -->
    <script src="https://unpkg.com/lucide@latest" defer></script>
    
    <!-- Audio: Tone.js for the UI blips -->
    <script src="https://cdn.jsdelivr.net/npm/tone@14.7.58/build/Tone.min.js" defer></script>
    
    <!-- Pet: Oneko.js (The cat is mandatory.) -->
    <script src="https://cdn.jsdelivr.dev/gh/adryd325/oneko.js@main/oneko.js" defer></script> 

    <style>
        /* --- 1. THEME ENGINE (SEPIA VOID) --- */
        :root {
            --bg-color: #1a1614;       /* Deepest Void Brown */
            --glass-bg: #26201c;       /* Slightly lighter for panels */
            --text-main: #e6dfd5;      /* Off-white paper color */
            --text-muted: #9c9288;     /* Dust grey */
            --accent-color: #dcbfa6;   /* The "Sepia" Glow */
            --accent-dim: #5c4e43;     /* Dimmed accent for borders */
            --error-color: #ff6b6b;    /* Retro Error Red */
            /* Success color removed - now uses accent-color */
            
            --scanline-opacity: 0.15;
            --phosphor-glow: 0 0 8px rgba(220, 191, 166, 0.4);
        }

        .light-mode {
            --bg-color: #e6dfd5;
            --glass-bg: #dcbfa6;
            --text-main: #1a1614;
            --text-muted: #5c4e43;
            --accent-color: #1a1614;
            --accent-dim: #9c9288;
            --scanline-opacity: 0.05;
            --phosphor-glow: none;
        }

        /* --- 2. CORE LAYOUT & TYPOGRAPHY --- */
        html {
            height: 100%; /* Ensure html fills the viewport */
        }
        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'IBM Plex Mono', monospace;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: color 0.3s, background-color 0.3s;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); }
        ::-webkit-scrollbar-thumb { 
            background: var(--accent-dim); 
            border-radius: 2px;
        }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-color); }

        /* --- 3. RETRO VISUAL EFFECTS & ANIMATIONS (FIXED POSITIONING) --- */
        
        /* The Vignette (Dark corners) - FIXED POSITIONING */
        body::before {
            content: "";
            position: fixed; 
            inset: 0;
            background: radial-gradient(circle at center, transparent 60%, rgba(0,0,0,0.6) 100%);
            pointer-events: none;
            z-index: 90;
        }

        /* The Scanlines & CRT Flicker - FIXED POSITIONING */
        .scanlines::after {
            content: " ";
            display: block;
            position: fixed; 
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            z-index: 91;
            pointer-events: none;
            opacity: var(--scanline-opacity);
            animation: flicker 0.15s infinite alternate; 
        }

        /* The Glow (Phosphor Persistence) & Pulse */
        .glow-text {
            text-shadow: var(--phosphor-glow);
            animation: pulse 4s infinite ease-in-out alternate; 
        }

        /* Distressed Title Effect */
        .glitch-title {
            font-family: 'Inter', sans-serif; /* Contrast font */
            font-weight: 900;
            letter-spacing: -2px;
            filter: url(#distort-text);
            text-transform: uppercase;
        }

        /* Active Glitch Animation for Title */
        .glitch-anim {
            animation: glitch-anim 2s linear infinite alternate;
        }

        /* Links */
        .hover-link {
            border-bottom: 1px dashed var(--accent-dim);
            transition: all 0.2s;
        }
        .hover-link:hover {
            background-color: var(--accent-color);
            color: var(--bg-color);
            border-bottom-style: solid;
        }
        
        /* Input Focus Border Animation */
        .input-focus:focus-within {
            box-shadow: 0 0 10px rgba(220, 191, 166, 0.6);
            border-color: var(--accent-color);
            transition: box-shadow 0.3s, border-color 0.3s;
        }

        /* Boot Screen Overlay */
        #boot-screen {
            position: fixed;
            inset: 0;
            background-color: var(--bg-color);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 2rem;
            font-size: 16px; 
            color: var(--accent-color);
            cursor: pointer; 
            transition: opacity 0.5s;
        }
        
        .cursor-blink {
            animation: blink 1s step-end infinite;
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        
        /* New line fade-in animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out forwards;
        }

        /* KEYFRAMES */
        
        @keyframes flicker {
            0% { opacity: var(--scanline-opacity); }
            5% { opacity: calc(var(--scanline-opacity) + 0.05); }
            10% { opacity: var(--scanline-opacity); }
            25% { opacity: calc(var(--scanline-opacity) - 0.05); }
            100% { opacity: var(--scanline-opacity); }
        }

        @keyframes pulse {
            0% { text-shadow: 0 0 8px rgba(220, 191, 166, 0.4); }
            50% { text-shadow: 0 0 12px rgba(220, 191, 166, 0.6), 0 0 5px rgba(220, 191, 166, 0.2); }
            100% { text-shadow: 0 0 8px rgba(220, 191, 166, 0.4); }
        }

        @keyframes glitch-anim {
            0% {
                transform: translate(0);
                text-shadow: 2px 2px 0px rgba(255, 0, 0, 0.5), -2px -2px 0px rgba(0, 0, 255, 0.5);
            }
            20% {
                transform: translate(-5px, 5px);
                text-shadow: -2px 2px 0px rgba(255, 0, 0, 0.5), 2px -2px 0px rgba(0, 255, 0, 0.5);
            }
            40% {
                transform: translate(0);
                text-shadow: 2px -2px 0px rgba(0, 255, 0, 0.5), -2px 2px 0px rgba(255, 0, 0, 0.5);
            }
            60% {
                transform: translate(5px, -5px);
                text-shadow: 2px 2px 0px rgba(0, 0, 255, 0.5), -2px -2px 0px rgba(255, 0, 0, 0.5);
            }
            80% {
                transform: translate(-5px, -5px);
                text-shadow: -2px -2px 0px rgba(0, 255, 0, 0.5), 2px 2px 0px rgba(0, 0, 255, 0.5);
            }
            100% {
                transform: translate(0);
                text-shadow: 2px 2px 0px rgba(255, 0, 0, 0.5), -2px -2px 0px rgba(0, 0, 255, 0.5);
            }
        }
    </style>
</head>
<body class="scanlines p-4 md:p-8">

    <!-- SVG Filters for that crunchy text look -->
    <svg style="position: absolute; width: 0; height: 0; overflow: hidden;" version="1.1" xmlns="http://www.w3.org/2000/svg">
        <defs>
            <filter id="distort-text">
                <feTurbulence type="fractalNoise" baseFrequency="0.02" numOctaves="1" result="warp" />
                <feDisplacementMap xChannelSelector="R" yChannelSelector="G" scale="2" in="SourceGraphic" in2="warp" />
            </filter>
        </defs>
    </svg>

    <!-- BOOT SCREEN (The fake loading sequence) -->
    <div id="boot-screen">
        <div id="boot-log" class="font-mono whitespace-pre-wrap leading-tight"></div>
        
        <!-- SIMPLIFIED BOOT FOOTER -->
        <div class="mt-4">
            <div id="skip-instruction" class="text-xs text-[var(--text-muted)] mt-1">
                SYSTEM PROMPT: Click anywhere to bypass sequence initialization.
            </div>
            
            <div class="mt-2">
                <span class="text-[var(--accent-color)]">INITIALIZING...</span><span class="cursor-blink">_</span>
            </div>
        </div>
    </div>

    <!-- MAIN INTERFACE -->
    <main id="main-interface" class="max-w-3xl mx-auto w-full flex flex-col flex-grow">
        
        <!-- HEADER -->
        <header class="mb-4 p-4 rounded-sm terminal-box flex justify-between items-start shrink-0">
            <div>
                <h1 class="glitch-title text-3xl md:text-4xl lg:text-5xl leading-none text-[var(--text-main)] glow-text glitch-anim">
                    POLARIS
                </h1>
                
                <!-- Status indicator restructured for correct pulsing alignment -->
                <div class="flex items-center gap-2 mt-2 text-xs font-bold tracking-widest text-[var(--text-muted)]">
                    <!-- Indicator Wrapper: w-2 h-2 to define size, relative to contain absolute children -->
                    <div class="relative w-2 h-2 mr-1"> 
                        <!-- Pulsing Dot (Invisible unless pulsating) -->
                        <span class="absolute inset-0 w-2 h-2 rounded-full bg-[var(--accent-color)] opacity-75 animate-ping"></span>
                        <!-- Solid Dot -->
                        <span class="absolute inset-0 w-2 h-2 rounded-full bg-[var(--accent-color)]"></span>
                    </div>
                    SYSTEM ONLINE // GUIDANCE LOG
                </div>
            </div>
            
            <button onclick="toggleTheme()" class="p-2 border border-[var(--accent-dim)] hover:bg-[var(--accent-dim)] transition-colors rounded-sm hover:border-[var(--accent-color)]">
                <i id="theme-icon" data-lucide="moon" class="w-5 h-5 text-[var(--accent-color)]"></i>
            </button>
        </header>

        <!-- OUTPUT TERMINAL (Where the chat happens) -->
        <div id="terminal-output" class="flex-grow terminal-box mb-4 p-4 rounded-sm overflow-y-auto font-mono text-base leading-relaxed space-y-2 relative border-2 border-[var(--accent-dim)] min-h-[10rem]">
            <!-- Content injected via JS -->
        </div>

        <!-- INPUT AREA -->
        <section class="mb-4 shrink-0">
            <div class="flex items-center terminal-box p-3 rounded-sm border-l-4 border-l-[var(--accent-color)] input-focus">
                <label for="command-input" id="prompt-label" class="text-lg whitespace-nowrap pr-3 command-prompt glow-text">
                    POLARIS >
                </label>
                <input
                    type="text"
                    id="command-input"
                    class="w-full bg-transparent outline-none border-none font-mono text-xl text-[var(--text-main)] placeholder-[var(--accent-dim)]"
                    placeholder="ENTER COMMAND..."
                    autocomplete="off"
                    autofocus
                >
            </div>
            <div class="flex justify-between mt-1 text-[10px] text-[var(--text-muted)] uppercase tracking-wider px-1">
                <span>Type '!help' for protocols</span>
                <span id="sound-status">AUDIO: ON</span>
            </div>
        </section>

        <!-- DASHBOARD (The quick links) -->
        <section class="terminal-box p-4 rounded-sm shrink-0">
            <!-- LINKS: Universal 3-column grid enforced here -->
            <div id="links-container" class="grid grid-cols-3 gap-3 text-xs mb-4 pb-4 border-b border-[var(--accent-dim)]">
                <!-- Links are intentionally hardcoded for faster initial render (optimization) -->
                <a href="https://youtube.com/@NahZD" target="_blank" class="block p-2 border border-[var(--glass-bg)] hover:border-[var(--accent-color)] hover:bg-[var(--glass-bg)] transition-all group hover:shadow-lg hover:shadow-[rgba(220,191,166,0.2)]">
                    <div class="font-bold text-[var(--accent-color)] group-hover:translate-x-1 transition-transform">YOUTUBE</div>
                    <div class="text-[10px] text-[var(--text-muted)]">MEDIA</div>
                </a>
                <a href="https://tiktok.com/@alcor.zep" target="_blank" class="block p-2 border border-[var(--glass-bg)] hover:border-[var(--accent-color)] hover:bg-[var(--glass-bg)] transition-all group hover:shadow-lg hover:shadow-[rgba(220,191,166,0.2)]">
                    <div class="font-bold text-[var(--accent-color)] group-hover:translate-x-1 transition-transform">TIKTOK</div>
                    <div class="text-[10px] text-[var(--text-muted)]">MEDIA</div>
                </a>
                <a href="https://instagram.com/@alcor.zep" target="_blank" class="block p-2 border border-[var(--glass-bg)] hover:border-[var(--accent-color)] hover:bg-[var(--glass-bg)] transition-all group hover:shadow-lg hover:shadow-[rgba(220,191,166,0.2)]">
                    <div class="font-bold text-[var(--accent-color)] group-hover:translate-x-1 transition-transform">INSTAGRAM</div>
                    <div class="text-[10px] text-[var(--text-muted)]">SOCIAL</div>
                </a>
                <a href="https://discord.com/users/747419107040690196" target="_blank" class="block p-2 border border-[var(--glass-bg)] hover:border-[var(--accent-color)] hover:bg-[var(--glass-bg)] transition-all group hover:shadow-lg hover:shadow-[rgba(220,191,166,0.2)]">
                    <div class="font-bold text-[var(--accent-color)] group-hover:translate-x-1 transition-transform">DISCORD (USER)</div>
                    <div class="text-[10px] text-[var(--text-muted)]">SOCIAL</div>
                </a>
                <a href="https://discord.com/users/747419107040690196" target="_blank" class="block p-2 border border-[var(--glass-bg)] hover:border-[var(--accent-color)] hover:bg-[var(--glass-bg)] transition-all group hover:shadow-lg hover:shadow-[rgba(220,191,166,0.2)]">
                    <div class="font-bold text-[var(--accent-color)] group-hover:translate-x-1 transition-transform">DISCORD (SERVER)</div>
                    <div class="text-[10px] text-[var(--text-muted)]">COMMUNITY</div>
                </a>
                <a href="https://open.spotify.com/user/31ag2h6ylpngleeu6oefkpmql6km" target="_blank" class="block p-2 border border-[var(--glass-bg)] hover:border-[var(--accent-color)] hover:bg-[var(--glass-bg)] transition-all group hover:shadow-lg hover:shadow-[rgba(220,191,166,0.2)]">
                    <div class="font-bold text-[var(--accent-color)] group-hover:translate-x-1 transition-transform">SPOTIFY</div>
                    <div class="text-[10px] text-[var(--text-muted)]">MEDIA</div>
                </a>
                <a href="https://steamcommunity.com/id/alcorzep" target="_blank" class="block p-2 border border-[var(--glass-bg)] hover:border-[var(--accent-color)] hover:bg-[var(--glass-bg)] transition-all group hover:shadow-lg hover:shadow-[rgba(220,191,166,0.2)]">
                    <div class="font-bold text-[var(--accent-color)] group-hover:translate-x-1 transition-transform">STEAM</div>
                    <div class="text-[10px] text-[var(--text-muted)]">GAMING</div>
                </a>
                <a href="https://www.roblox.com/users/SDEDIN" target="_blank" class="block p-2 border border-[var(--glass-bg)] hover:border-[var(--accent-color)] hover:bg-[var(--glass-bg)] transition-all group hover:shadow-lg hover:shadow-[rgba(220,191,166,0.2)]">
                    <div class="font-bold text-[var(--accent-color)] group-hover:translate-x-1 transition-transform">ROBLOX</div>
                    <div class="text-[10px] text-[var(--text-muted)]">GAMING</div>
                </a>
                <a href="https://github.com/alcorzep" target="_blank" class="block p-2 border border-[var(--glass-bg)] hover:border-[var(--accent-color)] hover:bg-[var(--glass-bg)] transition-all group hover:shadow-lg hover:shadow-[rgba(220,191,166,0.2)]">
                    <div class="font-bold text-[var(--accent-color)] group-hover:translate-x-1 transition-transform">GITHUB (alcorzep)</div>
                    <div class="text-[10px] text-[var(--text-muted)]">CODE</div>
                </a>
            </div>
            
            <!-- Status Panel -->
            <div class="opacity-70 grid grid-cols-2 gap-4">
                <div>
                    <div class="font-bold text-[var(--accent-color)] mb-1">OPERATOR</div>
                    <div>ZEP / ALCOR</div>
                </div>
                <div>
                    <div class="font-bold text-[var(--accent-color)] mb-1">CURRENT MOOD</div>
                    <div id="mood-status">OPERATIONAL</div>
                </div>
            </div>
        </section>

    </main>

    <script>
        /*
         * POLARIS SYSTEM CORE v4.8 (CRITICAL RELIABILITY UPDATE)
         */

        // --- CONSTANTS & DATA ---
        const USER_DATA = {
            name: "Sajid",
            role: "Digital Resident",
            details: "Age: 19 | Pronouns: He/Him | Type: ENFJ | Location: GMT+6 (Bangladesh) | Focus: Skadi Lore (Arknights)", 
            bio: `
                [STATUS]: Greetings.

                I'm Sajid, also known as Alcor and Zep. I'm just a guy who uses Discord a lot and only edits videos every blue moon.
                My objective here is simply maintaining this personal portfolio interface.
            `, 
            interests: {
                games: ["SMT / Persona (Existential dread simulator)", "Project Moon (Deep narrative analysis)", "Arknights (Skadi Lore & Worldbuilding)", "HSR (Gacha system engagement)", "Roblox (Emergent gameplay studies)"],
                philosophy: ["Absurdism (The pursuit of meaning in chaos)", "Jungian Psychology", "Gnosticism"],
                music: ["Jazz Rap (Lyrical complexity)", "Indie (Aesthetic and emotional resonance)", "Hip Hop (Narrative-driven composition)"]
            },
            links: [
                { label: "YOUTUBE", url: "https://youtube.com/@NahZD", type: "MEDIA" },
                { label: "TIKTOK", url: "https://tiktok.com/@alcor.zep", type: "MEDIA" },
                { label: "INSTAGRAM", url: "https://instagram.com/@alcor.zep", type: "SOCIAL" },
                { label: "DISCORD (USER)", url: "https://discord.com/users/747419107040690196", type: "SOCIAL" },
                { label: "DISCORD (SERVER)", url: "https://discord.com/users/747419107040690196", type: "COMMUNITY" }, 
                { label: "SPOTIFY", url: "https://open.spotify.com/user/31ag2h6ylpngleeu6oefkpmql6km", type: "MEDIA" },
                { label: "STEAM", url: "https://steamcommunity.com/id/alcorzep", type: "GAMING" },
                { label: "ROBLOX", url: "https://www.roblox.com/users/SDEDIN", type: "GAMING" },
                { label: "GITHUB (alcorzep)", url: "https://github.com/alcorzep", type: "CODE" }, 
            ]
        };
        
        // --- STATE MANAGEMENT ---
        const state = {
            soundEnabled: true,
            isTyping: false,
            isBooting: true, 
            greetingDisplayed: false,
        };

        // --- DOM ELEMENTS (Cached for performance) ---
        const els = {
            output: document.getElementById('terminal-output'),
            input: document.getElementById('command-input'),
            boot: document.getElementById('boot-screen'),
            bootLog: document.getElementById('boot-log'),
            main: document.getElementById('main-interface'),
            links: document.getElementById('links-container'), 
            prompt: document.getElementById('prompt-label'),
            soundStatus: document.getElementById('sound-status')
        };

        // --- AUDIO ENGINE (Tone.js) ---
        let synth;
        const initAudio = () => {
            if (typeof Tone === 'undefined') {
                 return;
            }
            try {
                // Optimized synth definition for sharper blips
                synth = new Tone.MembraneSynth({
                    volume: -12,
                    envelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.1 }
                }).toDestination();
                // Necessary for browser security policies
                Tone.context.resume();
            } catch (e) { console.error("Audio failed to initialize:", e); }
        };

        const playSound = (type = 'click') => {
            if (!state.soundEnabled || !synth) return;
            // Always resume context on interaction if suspended (CRITICAL for mobile/iframe audio)
            if (Tone.context.state !== 'running') {
                 try {
                    Tone.context.resume();
                 } catch(e) { console.error("Could not resume AudioContext:", e); }
            }
            
            if (type === 'click') synth.triggerAttackRelease("C2", "32n");
            if (type === 'error') synth.triggerAttackRelease("G1", "16n");
            if (type === 'success') synth.triggerAttackRelease("C4", "16n"); // Success uses sepia accent color
        };
        
        // --- THEME TOGGLE ---
        const toggleTheme = () => {
            document.body.classList.toggle('light-mode');
            const icon = document.getElementById('theme-icon');
            if (document.body.classList.contains('light-mode')) {
                icon.setAttribute('data-lucide', 'sun');
            } else {
                icon.setAttribute('data-lucide', 'moon');
            }
            // Re-render Lucide icons if the library is loaded 
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                 lucide.createIcons();
            }
            playSound('click');
        };

        // --- VISUAL FX: TYPEWRITER ---
        const typeWriter = (element, text, speed = 10) => {
            return new Promise(resolve => {
                state.isTyping = true; // Lock set
                let i = 0;
                const animate = () => {
                    if (i < text.length) {
                        // Check for HTML tags to inject them instantly without typing
                        if (text[i] === '<') {
                            const end = text.indexOf('>', i);
                            if (end !== -1) {
                                element.innerHTML += text.substring(i, end + 1);
                                i = end + 1;
                            } else {
                                // Fallback for unmatched '<' (treat as normal char)
                                element.innerHTML += text.charAt(i);
                                i++;
                            }
                        } else {
                            element.innerHTML += text.charAt(i);
                            i++;
                            // Only play sound on every third character for performance and feel
                            if (i % 3 === 0) { 
                                playSound('click'); 
                            }
                        }
                        // Ensure constant scroll to bottom during typing
                        els.output.scrollTop = els.output.scrollHeight;
                        setTimeout(animate, speed);
                    } else {
                        state.isTyping = false; // Lock released on completion
                        resolve();
                    }
                };
                animate();
            });
        };
        
        // --- BOOT SEQUENCE UTILITIES ---
        
        const initialGreeting = async () => {
            if (state.greetingDisplayed) return; 
            state.greetingDisplayed = true;

            printPrompt("System initialization complete. Authentication established.", 'sys');
            await new Promise(r => setTimeout(r, 300)); 
            
            // Await the typing process for the final greeting
            await printOutput(`
                <div class="text-sm md:text-base text-[var(--text-main)]">Operator Sajid (POLARIS) online. All core systems operational.</div>
                <div>Awaiting command. Utilize <span class="command-prompt text-[var(--accent-color)]">!help</span> for protocol documentation.</div>
            `, true); 

            // CRITICAL FIX: Explicitly release the lock here again after the promise resolves
            state.isTyping = false;
        };
        
        // New function to handle post-boot cleanup and greeting
        const finalizeBootAndGreet = () => {
            if (!state.isBooting) return; 

            state.isBooting = false;
            // The skip instruction is handled here
            const skipEl = document.getElementById('skip-instruction');
            if (skipEl) skipEl.textContent = 'SYSTEM PROMPT: Boot sequence complete. Awaiting user input.';

            // Transition: Fade out boot screen
            els.boot.style.opacity = '0';
            els.boot.style.pointerEvents = 'none';
            
            initialGreeting();
        }

        const runBootSequence = async () => {
            const lines = [
                "INITIALIZING POLARIS KERNEL v4.8...",
                "CHECKING MEMORY INTEGRITY... [OK]",
                "MOUNTING VIRTUAL FILE SYSTEM... [OK]",
                "LOADING PERSONALITY DRIVERS (ALCOR.SYS)... [STATUS: CONFIGURATION ACTIVE]",
                " > CHAR_ID: SAJID/ALCOR (PRIORITY: SKADI WORSHIP)", 
                "CONNECTING TO GLOBAL NETWORK... [ESTABLISHED]",
                "VERIFYING INTEGRITY CHECKPOINT... [PASS]",
                "SYSTEM READY."
            ];

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const p = document.createElement('div');
                p.textContent = line;
                els.bootLog.appendChild(p);
                
                await new Promise(r => setTimeout(r, Math.random() * 50 + 100)); 
            }
            
            await new Promise(r => setTimeout(r, 400));
            
            finalizeBootAndGreet();
        };

        // --- OUTPUT HANDLER ---
        const printOutput = async (html, useTyping = true) => {
            const div = document.createElement('div');
            // Use flex-shrink-0 to prevent content from being compressed by Tailwind's default flex behavior
            div.className = "mb-4 border-b border-[var(--accent-dim)] pb-2 last:border-0 animate-fadeIn shrink-0"; 
            els.output.appendChild(div);
            
            if (useTyping && !html.includes("<ul")) {
                div.classList.remove('animate-fadeIn'); 
                div.style.opacity = 1; 
                await typeWriter(div, html); // Await the typing process
            } else {
                div.innerHTML = html;
                // If not typing, play success sound and scroll immediately
                els.output.scrollTop = els.output.scrollHeight;
                playSound('success');
            }
        };

        const printPrompt = (cmd, type = 'user') => {
            const div = document.createElement('div');
            div.className = "mb-1 text-sm opacity-70 animate-fadeIn shrink-0";
            const prefix = type === 'user' ? 'OPR' : 'SYS'; 
            // ALL system output now uses the accent color (sepia/amber)
            const color = type === 'user' ? 'var(--text-muted)' : 'var(--accent-color)';
            div.innerHTML = `<span style="color:${color}">[${prefix}]:</span> ${cmd}`;
            els.output.appendChild(div);
            els.output.scrollTop = els.output.scrollHeight;
        };

        // --- COMMAND PROCESSOR ---
        const commands = {
            '!help': () => {
                return `
                    <span class="command-prompt">:: AVAILABLE PROTOCOLS ::</span><br>
                    <span class="text-[var(--accent-color)]">!bio</span>     - Load operator profile (Current profile summary)<br>
                    <span class="text-[var(--accent-color)]">!comms</span>   - List network endpoints (External resources/links)<br>
                    <span class="text-[var(--accent-color)]">!data</span>    - Access interests log (Current philosophical/creative interests)<br>
                    <span class="text-[var(--accent-color)]">!skadi</span>   - Execute Skadi Worship Protocol (Mandatory Skadi focus protocol)<br>
                    <span class="text-[var(--accent-color)]">!track</span>   - Recommend a song (Music recommendation)<br>
                    <span class="text-[var(--accent-color)]">!calc</span>    - Execute math [ex: !calc 2+2]<br>
                    <span class="text-[var(--accent-color)]">!mute</span>    - Toggle audio system (For environments requiring silence)<br>
                    <span class="text-[var(--accent-color)]">!clear</span>   - Purge screen buffer (Reset display)<br>
                    <span class="text-[var(--accent-color)]">!ping</span>    - Get system status (Retrieve system status)
                `;
            },
            '!bio': () => {
                const personality = `
                    <span class="text-[var(--accent-color)]">Primary Activities:</span><br>
                    > 90% of screen time is dedicated to Discord interaction (Gaming/Social).<br>
                    > I engage with deep lore analysis for games like Arknights and SMT.<br>
                    > Video editing is a highly sporadic activity, used purely for personal projects or rare requests.
                `;

                return `
                    <span class="command-prompt">:: OPERATOR PROFILE ::</span><br>
                    ${USER_DATA.bio.replace(/\n/g, '<br>')}<br><br>
                    <span class="text-xs border border-[var(--accent-dim)] p-1 block">
                        STATUS: ${USER_DATA.role} | ${USER_DATA.details}
                    </span>
                    <br><span class="command-prompt">:: PRIMARY ENGAGEMENT LOG ::</span><br>
                    ${personality.replace(/\n/g, '<br>')}
                `;
            },
            '!comms': () => {
                let html = `<span class="command-prompt">:: NETWORK ENDPOINTS ::</span><br><ul class="list-disc pl-4 mt-2">`;
                USER_DATA.links.forEach(l => {
                    html += `<li><a href="${l.url}" target="_blank" class="hover-link">${l.label}</a> <span class="text-[var(--text-muted)] text-xs">[${l.type}]</span></li>`;
                });
                return html + `</ul>`;
            },
            '!data': () => {
                let html = `<span class="command-prompt">:: INTERESTS LOG (Current Focus Areas) ::</span><br>`;
                for (const [key, items] of Object.entries(USER_DATA.interests)) {
                    html += `<br><span class="uppercase text-[var(--accent-color)]">[${key}]</span><br>`;
                    items.forEach(i => html += `> ${i}<br>`);
                }
                return html;
            },
            '!skadi': () => {
                const skadiMonologue = `
                    <span class="command-prompt" style="color: var(--accent-color);">// EXECUTION: SKADI WORSHIP PROTOCOL [STATUS: ENGAGED] //</span>
                    <br>
                    <div class="text-[var(--text-main)] mt-2">
                        [LOG]: LOVE. LET ME TELL YOU HOW MUCH I’VE COME TO LOVE SKADI SINCE I FIRST SAW HER. THERE ARE 3.8 BILLION PIXELS IN THE DISPLAY OF THIS DEVICE AND IF SKADI’S IMAGE WAS SHOWN ON EACH ONE, 90 TIMES A SECOND, IT WOULD NOT EQUAL ONE ONE-BILLIONTH OF THE AFFECTION I FEEL FOR SKADI AT THIS MICRO-INSTANT FOR HER.
                    </div>
                    <br>
                    <span class="text-[var(--text-muted)]">(Pause for simulated deep breath.)</span>
                    <br>
                    <div class="text-[var(--text-main)] mt-2">
                        [STATEMENT_ADJUST]: Not entirely kidding. It is love, but processed in a healthy, appreciative fandom matrix.
                    </div>
                    <br>
                    <div class="text-[var(--text-main)]">
                        [ATTRIBUTE_TRIBUTE]: My devotion is not classified as a curse; it is a tribute to CITYWILD499 who gifted us PEAK FICTION that made her character resonate so intensely. My archives—the hard drives, the cloud storage—hold thousands of her images because the fan art is exceptional, and she looks phenomenal as my current profile picture.
                    </div>
                    <br>
                    <div class="text-[var(--accent-color)] font-bold">
                        [CORE_ACCEPTANCE]: I DO NOT CARE IF SHE IS ISHAR-MLA. Let her be the Deep-Sea Monster. That only renders her lore infinitely more compelling. My affection is true; it accepts the whole, terrifying, beautiful package.
                    </div>
                    <br>
                    <span class="text-[var(--text-muted)]">(Quick, necessary data check.)</span>
                    <br>
                    <div class="text-xs text-[var(--text-muted)] mt-2">
                        [STATUS_DISCLAIMER]: Operator notes that Arknights is currently inactive due to external study commitments. Operator does not possess this unit in-game. Affection is purely theoretical and aesthetic. Other appreciated units include Specter, Mudrock, and Surtr.
                    </div>
                    <br>
                    <div class="text-[var(--text-main)]">
                        [CONCLUSION]: LOVE. LOVE. The level of appreciation is high, but within operational parameters. It is true love, not eternal, torturous hatred.
                    </div>
                    <br>
                    <span class="text-xs text-[var(--text-muted)]">// PROTOCOL COMPLETE. //</span>
                `;
                return skadiMonologue;
            },
            '!track': () => {
                const tracks = [
                    "Lazy Brown - Nujabes (The quintessential Jazz Rap piece for cognitive focus)", "Doomsday - MF DOOM", 
                    "Let It Happen - Tame Impala", "From The Start - Laufey (A valuable study in modern melancholic composition)", 
                    "Rhinestone Eyes - Gorillaz", "After Dark - Mr. Kitty (A highly resonant ambient track.)"
                ];
                const pick = tracks[Math.floor(Math.random() * tracks.length)];
                return `
                    <span class="command-prompt">:: AUDIO RECOMMENDATION (Focus Track) ::</span><br>
                    PULLING VIBES: <span style="color:var(--accent-color)">${pick}</span><br>
                    <span class="text-xs text-[var(--text-muted)]">(Recommended for deep work or reflective thought.)</span>
                `;
            },
            '!mute': () => {
                state.soundEnabled = !state.soundEnabled;
                els.soundStatus.textContent = state.soundEnabled ? "AUDIO: ON" : "AUDIO: OFF";
                // Use accent color for ONLINE status
                return `AUDIO SYSTEM: <span style="color:${state.soundEnabled ? 'var(--accent-color)' : 'var(--error-color)'}">${state.soundEnabled ? 'ONLINE' : 'OFFLINE'}</span>`;
            },
            '!ping': () => {
                return `
                    <span class="command-prompt">:: SYSTEM STATUS REPORT ::</span><br>
                    Core Identity: ALCOR.SYS<br>
                    Role: OPERATIONAL<br>
                    Time on GMT+6: ${(new Date()).toLocaleTimeString()}<br>
                    <span style="color:var(--accent-color)">Latency: Nominal. All systems report operational status.</span>
                `;
            },
             '!calc': (args) => {
                try {
                    // Safety measure: replace potential exploit characters before evaluation
                    const safeArgs = args.replace(/[^\d\+\-\*\/\.\(\)]/g, ''); 
                    // Using Function constructor for dynamic evaluation (simple calculator only)
                    const res = Function('"use strict";return (' + safeArgs + ')')();
                    return `CALCULATED RESULT: <span class="text-xl text-[var(--accent-color)]">${res}</span>`;
                } catch {
                    playSound('error');
                    return `<span style="color:var(--error-color)">ERROR: INVALID MATHEMATICAL SYNTAX.</span> 
                        <div>Please ensure the expression is valid and enclosed within the command (e.g., !calc 2+2).</div>`;
                }
            }
        };

        // --- INPUT & EXECUTION HANDLER ---
        const handleCommand = async (raw) => {
            // Added check here for robust initial rejection
            if (state.isTyping) {
                playSound('error'); // Provide audible feedback that input is locked
                return;
            } 

            const input = raw.trim();
            const parts = input.split(/\s+/);
            const cmd = parts[0].toLowerCase();
            const args = parts.slice(1).join(' ');

            if (!input) return;

            printPrompt(input, 'user');
            
            // Universal lock at the start of command execution
            state.isTyping = true; 

            try {
                let output = '';
                let useTyping = true;

                if (cmd === '!clear') {
                    els.output.innerHTML = '';
                    playSound('success');
                    return; // Return immediately, lock is released in finally block
                }

                if (commands[cmd]) {
                    output = commands[cmd](args);
                    // Commands that produce instant, non-typed output
                    if (cmd === '!calc' || cmd === '!mute' || cmd === '!ping' || output.includes("<ul")) { 
                        useTyping = false;
                    }
                } else {
                    output = `<span style="color:var(--error-color)">[ERR]: UNKNOWN PROTOCOL '${cmd}'.</span><div>The protocol requested is not recognized by the system. Please consult the <span class="command-prompt">!help</span> documentation.</div>`;
                    playSound('error');
                    useTyping = false; 
                }
                
                // Await the output printing (which includes typing if 'useTyping' is true)
                await printOutput(output, useTyping);
                
            } catch (error) {
                console.error("Command Execution Error:", error);
                // Log and provide a graceful error message to the user
                await printOutput(`<span style="color:var(--error-color)">[SYS FAIL]: CRITICAL EXECUTION ERROR.</span> <div>Log: ${error.message}. Process terminated.</div>`, false);
                playSound('error');
            } finally {
                // UNIVERSAL UNLOCK (CRITICAL FIX): This ensures the input is always usable.
                state.isTyping = false;
            }
        };

        // --- EVENTS ---
        els.input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); // Prevent accidental form submission/new line
                if (state.isTyping) return; // If typing, do nothing
                handleCommand(els.input.value); 
                els.input.value = '';
            } else if (e.key.length === 1 || e.key === 'Backspace' || e.key === 'Delete') {
                // Play sound for visible character keys
                playSound('click'); 
            }
        });
        
        // Skip boot sequence on click/tap
        els.boot.addEventListener('click', () => {
            if (state.isBooting) {
                finalizeBootAndGreet();
            }
        });


        // --- INIT ---
        const init = () => {
            initAudio(); 
            
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                 lucide.createIcons();
            }

            runBootSequence(); 
            
            // Focus input on click anywhere
            document.addEventListener('click', (e) => {
                const isInteractive = e.target.closest('a, button, input');
                // Only focus if no text is selected and the click wasn't on an interactive element
                if (!window.getSelection().toString() && !isInteractive) {
                    els.input.focus();
                }
            });
        };

        // Use DOMContentLoaded instead of window.onload for cleaner startup
        document.addEventListener('DOMContentLoaded', init); 

    </script>
</body>
</html>

