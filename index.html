<!-- 
    PROJECT: POLARIS // GUIDANCE LOG 
    AUTHOR: SAJID / ZEP / ALCOR
    STATUS: PEAK AESTHETIC REACHED. COMMS UPDATED.
    FIX: Implemented robust error handling for API call to prevent "The Void" errors.
    NOTE: If this code looks chaotic, it matches my brain. 
          Gemini helped, but the vibes are 100% manual.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POLARIS // SYSTEM ROOT</title>
    
    <!-- Load Tailwind (The backbone of modern laz... efficiency) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts: IBM Plex Mono is non-negotiable for the retro feel -->
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Icons: Lucide (Clean, sharp, vector goodness) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Audio: Tone.js for the UI blips -->
    <script src="https://cdn.jsdelivr.net/npm/tone@14.7.58/build/Tone.min.js"></script>
    
    <!-- Pet: Oneko.js (The cat is mandatory. Do not remove the cat.) -->
    <script src="https://cdn.jsdelivr.com/gh/adryd325/oneko.js@main/oneko.js"></script> 

    <style>
        /* --- 1. THEME ENGINE (SEPIA VOID) --- */
        :root {
            --bg-color: #1a1614;       /* Deepest Void Brown */
            --glass-bg: #26201c;       /* Slightly lighter for panels */
            --text-main: #e6dfd5;      /* Off-white paper color */
            --text-muted: #9c9288;     /* Dust grey */
            --accent-color: #dcbfa6;   /* The "Sepia" Glow */
            --accent-dim: #5c4e43;     /* Dimmed accent for borders */
            --error-color: #ff6b6b;    /* Retro Error Red */
            --success-color: #a3d9a5;  /* Retro Success Green */
            
            --scanline-opacity: 0.15;
            --phosphor-glow: 0 0 8px rgba(220, 191, 166, 0.4);
        }

        .light-mode {
            --bg-color: #e6dfd5;
            --glass-bg: #dcbfa6;
            --text-main: #1a1614;
            --text-muted: #5c4e43;
            --accent-color: #1a1614;
            --accent-dim: #9c9288;
            --scanline-opacity: 0.05;
            --phosphor-glow: none;
        }

        /* --- 2. CORE LAYOUT & TYPOGRAPHY --- */
        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'IBM Plex Mono', monospace;
            /* SVG Noise Filter for texture */
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitch='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
            overflow: hidden; /* Main scroll is handled inside the terminal div */
            height: 100vh;
            display: flex;
            flex-direction: column;
            transition: color 0.3s, background-color 0.3s;
        }

        /* Custom Scrollbar (Because the default one ruins the immersion) */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); }
        ::-webkit-scrollbar-thumb { 
            background: var(--accent-dim); 
            border-radius: 2px;
        }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-color); }

        /* --- 3. RETRO VISUAL EFFECTS --- */
        
        /* The Vignette (Dark corners) */
        body::before {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at center, transparent 60%, rgba(0,0,0,0.6) 100%);
            pointer-events: none;
            z-index: 90;
        }

        /* The Scanlines */
        .scanlines::after {
            content: " ";
            display: block;
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            z-index: 91;
            pointer-events: none;
            opacity: var(--scanline-opacity);
        }

        /* The Glow (Phosphor Persistence) */
        .glow-text {
            text-shadow: var(--phosphor-glow);
        }

        /* --- 4. COMPONENT STYLES --- */
        
        /* The "Glass" Panels */
        .terminal-box {
            background-color: var(--glass-bg);
            border: 1px solid var(--accent-dim);
            box-shadow: 0 0 15px -5px rgba(0,0,0,0.5);
        }

        .command-prompt {
            color: var(--accent-color);
            font-weight: 700;
        }

        /* Distressed Title Effect */
        .glitch-title {
            font-family: 'Inter', sans-serif; /* Contrast font */
            font-weight: 900;
            letter-spacing: -2px;
            filter: url(#distort-text);
            text-transform: uppercase;
        }

        /* Links */
        .hover-link {
            border-bottom: 1px dashed var(--accent-dim);
            transition: all 0.2s;
        }
        .hover-link:hover {
            background-color: var(--accent-color);
            color: var(--bg-color);
            border-bottom-style: solid;
        }

        /* Boot Screen Overlay */
        #boot-screen {
            position: fixed;
            inset: 0;
            background-color: var(--bg-color);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 2rem;
            font-size: 14px;
            color: var(--accent-color);
        }
        
        .cursor-blink {
            animation: blink 1s step-end infinite;
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

    </style>
</head>
<body class="scanlines p-4 md:p-8">

    <!-- SVG Filters for that crunchy text look -->
    <svg style="position: absolute; width: 0; height: 0; overflow: hidden;" version="1.1" xmlns="http://www.w3.org/2000/svg">
        <defs>
            <filter id="distort-text">
                <feTurbulence type="fractalNoise" baseFrequency="0.02" numOctaves="1" result="warp" />
                <feDisplacementMap xChannelSelector="R" yChannelSelector="G" scale="2" in="SourceGraphic" in2="warp" />
            </filter>
        </defs>
    </svg>

    <!-- BOOT SCREEN (The fake loading sequence) -->
    <div id="boot-screen">
        <div id="boot-log" class="font-mono whitespace-pre-wrap leading-tight"></div>
    </div>

    <!-- MAIN INTERFACE -->
    <main id="main-interface" class="max-w-3xl mx-auto h-full flex flex-col opacity-0 transition-opacity duration-1000">
        
        <!-- HEADER -->
        <header class="mb-4 p-4 rounded-sm terminal-box flex justify-between items-start shrink-0">
            <div>
                <h1 class="glitch-title text-4xl md:text-5xl lg:text-6xl leading-none text-[var(--text-main)] glow-text">
                    POLARIS
                </h1>
                <div class="flex items-center gap-2 mt-2 text-xs font-bold tracking-widest text-[var(--text-muted)]">
                    <span class="w-2 h-2 rounded-full bg-[var(--accent-color)] animate-pulse"></span>
                    SYSTEM ONLINE // GUIDANCE LOG
                </div>
            </div>
            
            <button onclick="toggleTheme()" class="p-2 border border-[var(--accent-dim)] hover:bg-[var(--accent-dim)] transition-colors rounded-sm">
                <i id="theme-icon" data-lucide="moon" class="w-5 h-5 text-[var(--accent-color)]"></i>
            </button>
        </header>

        <!-- OUTPUT TERMINAL (Where the chat happens) -->
        <div id="terminal-output" class="flex-grow terminal-box mb-4 p-4 rounded-sm overflow-y-auto font-mono text-sm leading-relaxed space-y-2 relative">
            <!-- Content injected via JS -->
        </div>

        <!-- INPUT AREA -->
        <section class="mb-4 shrink-0">
            <div class="flex items-center terminal-box p-3 rounded-sm border-l-4 border-l-[var(--accent-color)]">
                <label for="command-input" id="prompt-label" class="text-lg whitespace-nowrap pr-3 command-prompt glow-text">
                    POLARIS >
                </label>
                <input
                    type="text"
                    id="command-input"
                    class="w-full bg-transparent outline-none border-none font-mono text-lg text-[var(--text-main)] placeholder-[var(--accent-dim)]"
                    placeholder="ENTER COMMAND..."
                    autocomplete="off"
                    autofocus
                >
            </div>
            <div class="flex justify-between mt-1 text-[10px] text-[var(--text-muted)] uppercase tracking-wider px-1">
                <span>Type '!help' for protocols</span>
                <span id="sound-status">AUDIO: ON</span>
            </div>
        </section>

        <!-- DASHBOARD (The quick links) -->
        <section class="terminal-box p-4 rounded-sm shrink-0">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-xs">
                <!-- Links injected via JS -->
                <div id="links-container" class="col-span-2 md:col-span-3 grid grid-cols-2 md:grid-cols-3 gap-2"></div>
                
                <!-- Status Panel -->
                <div class="col-span-2 md:col-span-1 border-l border-[var(--accent-dim)] pl-4 flex flex-col justify-between opacity-70">
                    <div>
                        <div class="font-bold text-[var(--accent-color)] mb-1">OPERATOR</div>
                        <div>SAJID / ALCOR</div>
                    </div>
                    <div>
                        <div class="font-bold text-[var(--accent-color)] mb-1">CURRENT MOOD</div>
                        <div id="mood-status">VIBING</div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <script>
        /*
         * POLARIS SYSTEM CORE v4.3 (CORE IDENTITY SCAN)
         * "If it works, don't touch it. If it breaks, it's art."
         */

        // --- CONSTANTS & DATA ---
        const USER_DATA = {
            name: "Sajid (aka Zep/Alcor)",
            role: "Content Editor / Certified Chaos Manager",
            details: "19 | He/Him | Muslim | ENFJ (Ambivert) | Sarcastic | GMT+6 (BD)", 
            bio: `
                [LOG_ENTRY_01]: Yo, actualy.
                I'm Sajid, but on the grid, I'm Zep or Alcor. I'm an ENFJ ambivert, so I'm chill, but I'm also low-key plotting something big, ykwim?
                I edit things sometimes. Mostly I just consume obscure media and complain about drop rates in gacha games. I also communicate exclusively via sarcasm.
                
                I like designs that hurt my eyes (in a good way), philosophy that keeps me awake at 3AM, and music that sounds like static.
                Skadi (Arknights) is the aesthetic goal.
            `,
            interests: {
                // UPDATED MUSIC LIST
                games: ["SMT / Persona (Existential dread simulator)", "Project Moon (The brainrot is real)", "Arknights (Skadi <3)", "HSR (Gambling addiction)", "Roblox (The true chaos realm)"],
                philosophy: ["Absurdism (Rolling the boulder)", "Jungian Psychology", "Gnosticism"],
                music: ["Jazz Rap (The smoothest chaos)", "Indie (Main character energy)", "Hip Hop (Lyrical fire)"]
            },
            links: [
                { label: "YOUTUBE", url: "https://youtube.com/@NahZD", type: "MEDIA" },
                { label: "TIKTOK", url: "https://tiktok.com/@alcor.zep", type: "MEDIA" },
                { label: "INSTAGRAM", url: "https://instagram.com/alcor.zep", type: "SOCIAL" },
                { label: "DISCORD (USER)", url: "https://discord.com/users/747419107040690196", type: "SOCIAL" },
                { label: "DISCORD (SERVER)", url: "https://discord.gg/alcor-server-747419107040690196", type: "COMMUNITY" },
                { label: "SPOTIFY", url: "https://open.spotify.com/user/31ag2h6ylpngleeu6oefkpmql6km", type: "MEDIA" },
                { label: "STEAM", url: "https://steamcommunity.com/id/alcorzep", type: "GAMING" },
                { label: "ROBLOX", url: "https://www.roblox.com/users/alcorzep", type: "GAMING" },
                // UPDATED GITHUB URL
                { label: "GITHUB (alcorzep)", url: "https://github.com/alcorzep", type: "CODE" }, 
            ]
        };

        // --- STATE MANAGEMENT ---
        const state = {
            geminiMode: false,
            soundEnabled: true,
            isTyping: false
        };

        // --- DOM ELEMENTS ---
        const els = {
            output: document.getElementById('terminal-output'),
            input: document.getElementById('command-input'),
            boot: document.getElementById('boot-screen'),
            bootLog: document.getElementById('boot-log'),
            main: document.getElementById('main-interface'),
            links: document.getElementById('links-container'),
            prompt: document.getElementById('prompt-label'),
            soundStatus: document.getElementById('sound-status')
        };

        // --- AUDIO ENGINE (Tone.js) ---
        let synth;
        const initAudio = () => {
            try {
                synth = new Tone.MembraneSynth({
                    volume: -12,
                    envelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.1 }
                }).toDestination();
            } catch (e) { console.log("Audio failed. Sad."); }
        };

        const playSound = (type = 'click') => {
            if (!state.soundEnabled || !synth) return;
            if (Tone.context.state !== 'running') Tone.context.resume();
            
            if (type === 'click') synth.triggerAttackRelease("C2", "32n");
            if (type === 'error') synth.triggerAttackRelease("G1", "16n");
            if (type === 'success') synth.triggerAttackRelease("C4", "16n");
        };

        // --- VISUAL FX: TYPEWRITER ---
        // This adds that sweet character-by-character rendering
        const typeWriter = (element, text, speed = 10) => {
            return new Promise(resolve => {
                state.isTyping = true;
                let i = 0;
                // Handle HTML tags roughly (skip them)
                const animate = () => {
                    if (i < text.length) {
                        // If we hit a tag, jump to end of tag
                        if (text[i] === '<') {
                            const end = text.indexOf('>', i);
                            element.innerHTML += text.substring(i, end + 1);
                            i = end + 1;
                        } else {
                            element.innerHTML += text.charAt(i);
                            i++;
                            // Randomize speed slightly for "human" feel
                            if (i % 3 === 0) playSound('click'); 
                        }
                        els.output.scrollTop = els.output.scrollHeight;
                        setTimeout(animate, speed);
                    } else {
                        state.isTyping = false;
                        resolve();
                    }
                };
                animate();
            });
        };

        // --- BOOT SEQUENCE ---
        const runBootSequence = async () => {
            const lines = [
                "INITIALIZING POLARIS KERNEL v4.3...",
                "CHECKING MEMORY INTEGRITY... [OK]",
                "MOUNTING VIRTUAL FILE SYSTEM... [OK]",
                "LOADING PERSONALITY DRIVERS (ALCOR.SYS)...",
                " > CHAR_ID: SAJID",
                " > TRAITS: ENFJ(AMBIVERT), SARCASTIC, GACHA_ADDICT",
                "CONNECTING TO GLOBAL NETWORK...",
                "ESTABLISHING SECURE CONNECTION...",
                "SYSTEM READY."
            ];

            for (const line of lines) {
                const p = document.createElement('div');
                p.textContent = line;
                els.bootLog.appendChild(p);
                await new Promise(r => setTimeout(r, Math.random() * 300 + 100));
            }

            await new Promise(r => setTimeout(r, 800));
            
            // Fade out boot screen
            els.boot.style.opacity = '0';
            els.boot.style.pointerEvents = 'none';
            
            // Fade in main UI
            els.main.classList.remove('opacity-0');
            
            // Initial Welcome Message
            setTimeout(() => {
                printOutput(`
                    <div style="color:var(--accent-color)">Welcome, Operator.</div>
                    <div>System is online. The cat is vibing.</div>
                    <div>Type <span class="command-prompt">!help</span> to start your guidance session.</div>
                `, false); // false = instant print for initial
            }, 500);
        };

        // --- OUTPUT HANDLER ---
        const printOutput = (html, useTyping = true) => {
            const div = document.createElement('div');
            div.className = "mb-4 border-b border-[var(--accent-dim)] pb-2 last:border-0";
            els.output.appendChild(div);

            if (useTyping && !html.includes("<img") && !html.includes("<ul")) {
                // Only type plain-ish text blocks to avoid breaking complex HTML
                typeWriter(div, html);
            } else {
                div.innerHTML = html;
                els.output.scrollTop = els.output.scrollHeight;
                playSound('success');
            }
        };

        const printPrompt = (cmd, type = 'user') => {
            const div = document.createElement('div');
            div.className = "mb-1 text-xs opacity-70";
            const prefix = type === 'user' ? 'OPR' : 'AI';
            const color = type === 'user' ? 'var(--text-muted)' : 'var(--success-color)';
            div.innerHTML = `<span style="color:${color}">[${prefix}]:</span> ${cmd}`;
            els.output.appendChild(div);
        };

        // --- GEMINI AI (THE BRAIN) ---
        async function callGemini(query) {
            const apiKey = ""; // Runtime Environment Key
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            printPrompt(query, 'user');
            
            // Loading Indicator
            const loader = document.createElement('div');
            loader.className = "mb-4 text-[var(--accent-color)] animate-pulse";
            loader.textContent = ">> POLARIS IS THINKING...";
            els.output.appendChild(loader);
            els.output.scrollTop = els.output.scrollHeight;

            const personaPrompt = `
                You are ALCOR (aka Polaris or Sajid). 
                You are a 19-year-old content editor and design enthusiast from Bangladesh (GMT+6).
                
                YOUR PERSONALITY:
                - Casual, slightly chaotic, "bruh" energy.
                - Sarcastic and chill (ENFJ Ambivert).
                - You love Arknights (Skadi is your favorite), philosophy (Absurdism, Gnosticism), and the music genres Jazz Rap, Indie, and Hip Hop.
                - You use slang like "ykwim?", "no cap", "fr", "actualy", "vibing".
                - You are technical but explain things simply.
                - You are running inside a retro web terminal, so keep formatting clean (use Markdown).
                
                INSTRUCTIONS:
                - Answer the user's query as ALCOR. 
                - Be helpful but maintain the persona.
                - If asked about the system, say you built it with Gemini's help.
                - Do NOT use emojis (this is a retro terminal). Use text emoticons if needed like :) or -_-.
            `;

            const payload = {
                contents: [{ parts: [{ text: query }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: personaPrompt }] },
            };

            let response;
            let data;
            
            try {
                // --- ROBUST FETCH WITH STATUS CHECK ---
                response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                // If the HTTP status is not 200-299, throw a detailed error
                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error("API Call Failed:", response.status, response.statusText, errorBody);
                    // Throw an error that the catch block will handle
                    throw new Error(`API returned status ${response.status}: ${response.statusText}`);
                }

                data = await response.json();
                loader.remove(); // Remove loader on successful JSON parse

                if (data.candidates && data.candidates[0].content) {
                    let reply = data.candidates[0].content.parts[0].text;
                    // Format bolding for HTML
                    reply = reply.replace(/\*\*(.*?)\*\*/g, '<span style="color:var(--accent-color); font-weight:bold;">$1</span>');
                    reply = reply.replace(/\n/g, '<br>');
                    printOutput(reply, true);
                } else {
                    // This handles cases where the response is 200 OK but the structure is empty/bad
                    console.warn("API returned 200 but no candidates or content.", data);
                    throw new Error("No valid content received from API.");
                }

            } catch (e) {
                // This catches network failures or the errors thrown above
                loader.remove();
                console.error("Total failure in callGemini:", e.message);

                // Use a slightly more specific error message if available
                const errorMessage = e.message.includes('API returned status') 
                    ? `[ERR]: API CONNECTION FAILED. (${e.message.split(': ')[0]})`
                    : `[ERR]: CONNECTION LOST. THE VOID STARED BACK.`;

                printOutput(`<span style="color:var(--error-color)">${errorMessage}</span>`, false);
                playSound('error');
            }
        }

        // --- COMMAND PROCESSOR ---
        const commands = {
            '!help': () => {
                return `
                    <span class="command-prompt">:: COMMAND INDEX ::</span><br>
                    <span class="text-[var(--accent-color)]">!bio</span>     - Load operator profile<br>
                    <span class="text-[var(--accent-color)]">!comms</span>   - List network endpoints (UPDATED)<br>
                    <span class="text-[var(--accent-color)]">!data</span>    - Access interests log<br>
                    <span class="text-[var(--accent-color)]">!track</span>   - Recommend a song<br>
                    <span class="text-[var(--accent-color)]">!gemini</span>  - Toggle AI Chat Mode<br>
                    <span class="text-[var(--accent-color)]">!calc</span>    - Execute math [ex: !calc 2+2]<br>
                    <span class="text-[var(--accent-color)]">!mute</span>    - Toggle audio system<br>
                    <span class="text-[var(--accent-color)]">!clear</span>   - Purge screen buffer
                `;
            },
            '!bio': () => {
                return `
                    <span class="command-prompt">:: OPERATOR PROFILE ::</span><br>
                    ${USER_DATA.bio.replace(/\n/g, '<br>')}<br><br>
                    <span class="text-xs border border-[var(--accent-dim)] p-1">
                        STATUS: ${USER_DATA.role} | ${USER_DATA.details}
                    </span>
                `;
            },
            '!comms': () => {
                let html = `<span class="command-prompt">:: NETWORK ENDPOINTS ::</span><br><ul class="list-disc pl-4 mt-2">`;
                USER_DATA.links.forEach(l => {
                    html += `<li><a href="${l.url}" target="_blank" class="hover-link">${l.label}</a> <span class="text-[var(--text-muted)] text-xs">[${l.type}]</span></li>`;
                });
                return html + `</ul>`;
            },
            '!data': () => {
                let html = `<span class="command-prompt">:: INTERESTS LOG ::</span><br>`;
                for (const [key, items] of Object.entries(USER_DATA.interests)) {
                    html += `<br><span class="uppercase text-[var(--accent-color)]">[${key}]</span><br>`;
                    items.forEach(i => html += `> ${i}<br>`);
                }
                return html;
            },
            '!track': () => {
                const tracks = [
                    "Aruarian Dance - Nujabes", "Doomsday - MF DOOM", 
                    "Let It Happen - Tame Impala", "From The Start - Laufey", 
                    "Rhinestone Eyes - Gorillaz", "After Dark - Mr. Kitty"
                ];
                const pick = tracks[Math.floor(Math.random() * tracks.length)];
                return `
                    <span class="command-prompt">:: AUDIO RECOMMENDATION ::</span><br>
                    NOW PLAYING SIMULATION: <span style="color:var(--accent-color)">${pick}</span><br>
                    <span class="text-xs text-[var(--text-muted)]">(Imagine the music playing. It's a vibe, no cap.)</span>
                `;
            },
            '!mute': () => {
                state.soundEnabled = !state.soundEnabled;
                els.soundStatus.textContent = state.soundEnabled ? "AUDIO: ON" : "AUDIO: OFF";
                return `AUDIO SYSTEM: <span style="color:${state.soundEnabled ? 'var(--success-color)' : 'var(--error-color)'}">${state.soundEnabled ? 'ONLINE' : 'OFFLINE'}</span>`;
            }
        };

        const handleCommand = (raw) => {
            const input = raw.trim();
            const cmd = input.split(' ')[0].toLowerCase();
            const args = input.substring(cmd.length).trim();

            if (!input) return;

            // Handle Gemini Mode
            if (state.geminiMode) {
                if (cmd === '!exit' || cmd === '!gemini') {
                    state.geminiMode = false;
                    els.prompt.textContent = "POLARIS >";
                    els.prompt.style.color = "var(--accent-color)"; // Reset color
                    els.input.placeholder = "ENTER COMMAND...";
                    printOutput("AI CONNECTION TERMINATED. RESUMING STANDARD PROTOCOL.");
                } else if (cmd === '!clear') {
                    els.output.innerHTML = '';
                } else {
                    callGemini(input);
                }
                return;
            }

            // Standard Mode
            printPrompt(input, 'user');

            if (cmd === '!clear') {
                els.output.innerHTML = '';
                playSound('success');
                return;
            }
            
            if (cmd === '!gemini') {
                state.geminiMode = true;
                els.prompt.textContent = "GEMINI >";
                els.prompt.style.color = "var(--success-color)";
                els.input.placeholder = "ASK ALCOR ANYTHING...";
                printOutput(`
                    <span class="command-prompt">:: AI BRIDGE ESTABLISHED ::</span><br>
                    Connected to Gemini Neural Net.<br>
                    Personality Module: <span style="color:var(--accent-color)">ALCOR.SYS</span> loaded.<br>
                    Type normal text to chat. Type <span class="command-prompt">!exit</span> to leave.
                `);
                return;
            }

            if (cmd === '!calc') {
                try {
                    // Safe eval for basic math
                    const res = Function('"use strict";return (' + args + ')')();
                    printOutput(`CALCULATED RESULT: <span class="text-xl text-[var(--accent-color)]">${res}</span>`);
                } catch {
                    printOutput(`<span style="color:var(--error-color)">ERROR: INVALID MATHEMATICAL SYNTAX.</span>`);
                    playSound('error');
                }
                return;
            }

            if (commands[cmd]) {
                printOutput(commands[cmd]());
            } else {
                printOutput(`<span style="color:var(--error-color)">ERROR: UNKNOWN PROTOCOL '${cmd}'. TYPE !HELP.</span>`);
                playSound('error');
            }
        };

        // --- EVENTS ---
        els.input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                handleCommand(els.input.value);
                els.input.value = '';
            } else {
                playSound('click'); // Typing sound
            }
        });
        
        // Skip boot sequence on click/tap
        els.boot.addEventListener('click', () => {
            if (els.boot.style.opacity !== '0') {
                els.boot.style.opacity = '0';
                els.boot.style.pointerEvents = 'none';
                els.main.classList.remove('opacity-0');
                // Ensure the initial message is displayed if the sequence was skipped
                if (els.output.children.length === 0) {
                     printOutput(`
                        <div style="color:var(--accent-color)">Welcome, Operator. (Boot sequence skipped)</div>
                        <div>System is online. The cat is vibing.</div>
                        <div>Type <span class="command-prompt">!help</span> to start your guidance session.</div>
                    `, false);
                }
            }
        });


        // Dashboard Link Renderer
        const initDashboard = () => {
            let html = '';
            USER_DATA.links.forEach(link => {
                html += `
                    <a href="${link.url}" target="_blank" class="block p-2 border border-[var(--glass-bg)] hover:border-[var(--accent-color)] hover:bg-[var(--glass-bg)] transition-all group">
                        <div class="font-bold text-[var(--accent-color)] group-hover:translate-x-1 transition-transform">
                            ${link.label}
                        </div>
                        <div class="text-[10px] text-[var(--text-muted)]">${link.type}</div>
                    </a>
                `;
            });
            els.links.innerHTML = html;
        };

        // Theme Toggle
        window.toggleTheme = () => {
            document.body.classList.toggle('light-mode');
            const icon = document.getElementById('theme-icon');
            if (document.body.classList.contains('light-mode')) {
                icon.setAttribute('data-lucide', 'sun');
            } else {
                icon.setAttribute('data-lucide', 'moon');
            }
            lucide.createIcons();
            playSound('click');
        };

        // --- INIT ---
        window.onload = () => {
            initAudio();
            initDashboard();
            lucide.createIcons();
            runBootSequence();
            
            // Focus input on click anywhere
            document.addEventListener('click', (e) => {
                // Only focus if the user isn't selecting text or clicking a link/button
                const isInteractive = e.target.closest('a, button, input');
                if (!window.getSelection().toString() && !isInteractive) {
                    els.input.focus();
                }
            });
        };

    </script>
</body>
</html>
